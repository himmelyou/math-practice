<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Jarvis Math Lab 计算游戏</title>
  <script src="config.js"></script>
  <style>
    :root {
      --bg: #e6f3ff;
      --card-bg: #ffffff;
      --primary: #1976d2;
      --primary-light: #63a4ff;
      --danger: #d32f2f;
      --success: #2e7d32;
      --text-main: #123047;
      --muted: #607d8b;
      --border-radius: 14px;
      --shadow-soft: 0 10px 25px rgba(0, 0, 0, 0.08);
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "PingFang SC", "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: radial-gradient(circle at top left, #f5fbff, var(--bg));
      color: var(--text-main);
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .login-view {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 16px;
    }

    .login-card {
      width: 100%;
      max-width: 380px;
      background: #ffffff;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-soft);
      padding: 18px 18px 16px;
    }

    .login-title {
      margin: 0 0 6px;
      font-size: 1.4rem;
      font-weight: 700;
      color: #0d47a1;
      text-align: left;
    }

    .login-subtitle {
      margin: 0 0 14px;
      font-size: 0.86rem;
      color: var(--muted);
    }

    .login-field {
      margin-bottom: 10px;
    }

    .login-field input {
      width: 100%;
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(13, 71, 161, 0.16);
      outline: none;
      font-size: 0.95rem;
      box-sizing: border-box;
    }

    .login-field input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.16);
      background: #f7fbff;
    }

    .login-btn {
      width: 100%;
      margin-top: 4px;
      border-radius: 999px;
      border: none;
      padding: 9px 14px;
      font-size: 0.96rem;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: #fff;
      box-shadow: 0 6px 14px rgba(25, 118, 210, 0.4);
    }

    .guest-btn {
      margin-top: 8px;
      background: #f1f6ff;
      color: var(--primary);
      box-shadow: none;
      border: 1px solid rgba(25, 118, 210, 0.25);
    }

    .login-error {
      min-height: 18px;
      margin-top: 6px;
      font-size: 0.8rem;
      color: var(--danger);
    }

    .login-hint {
      margin-top: 8px;
      font-size: 0.78rem;
      color: var(--muted);
    }

    .login-version {
      margin-top: 10px;
      margin-bottom: 0;
      font-size: 0.72rem;
      color: var(--muted);
    }

    .app {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 16px;
      max-width: 720px;
      margin: 0 auto;
    }

    .app-header {
      text-align: left;
      padding: 8px 4px 8px;
    }

    .app-title {
      margin: 0 0 6px;
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: 0.04em;
      color: #0d47a1;
    }

    .subtitle {
      margin: 0;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .user-bar {
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 0.82rem;
      color: var(--muted);
    }

    .user-name {
      font-weight: 600;
      color: var(--primary);
    }

    .logout-btn {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 0.8rem;
      cursor: pointer;
      background: #f5f7ff;
      color: #546e7a;
    }

    .status-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px 12px;
      margin-top: 8px;
    }

    .status-item {
      font-size: 0.8rem;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
      min-width: 0;
    }

    .status-item-full {
      grid-column: 1 / -1;
    }

    .status-label {
      opacity: 0.8;
    }

    .status-value {
      font-weight: 600;
      color: var(--text-main);
    }

    .status-value.highlight {
      color: var(--primary);
    }

    .status-value.danger {
      color: var(--danger);
    }

    .status-value.success {
      color: var(--success);
    }

    .card {
      flex: 1;
      margin-top: 8px;
      padding: 18px 16px 14px;
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .question-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .question-label {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--primary);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: rgba(25, 118, 210, 0.08);
      color: var(--primary);
    }

    .badge.remedial {
      background: rgba(255, 193, 7, 0.18);
      color: #f57f17;
    }

    .timer-chip {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      background: rgba(25, 118, 210, 0.06);
      color: var(--primary);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .timer-chip.low {
      background: rgba(211, 47, 47, 0.08);
      color: var(--danger);
    }

    .question-text {
      margin-top: 4px;
      font-size: 1.25rem;
      font-weight: 600;
      text-align: center;
      padding: 8px 6px 4px;
    }

    .question-subtext {
      font-size: 0.85rem;
      text-align: center;
      color: var(--muted);
    }

    .answer-form {
      margin: 0;
      max-width: 380px;
      margin-left: auto;
      margin-right: auto;
    }

    .input-row {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }

    .input-row input[type="number"] {
      flex: 1;
      padding: 10px 12px;
      font-size: 16px; /* 避免 iOS 聚焦输入框时自动放大页面 */
      border-radius: 999px;
      border: 1px solid rgba(13, 71, 161, 0.16);
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background-color 0.15s ease;
      text-align: center;
    }

    .input-row input[type="number"]:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.16);
      background: #f7fbff;
    }

    .button-row {
      display: flex;
      gap: 10px;
      margin-top: 8px;
    }
    .game-back-row {
      margin-top: 10px;
    }
    .game-back-row.hidden {
      display: none;
    }
    #game-back-home-btn {
      width: 100%;
      padding: 16px 20px;
      min-height: 2.8em;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 10px 14px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.12s ease, background-color 0.12s ease, opacity 0.12s ease;
      font-family: inherit;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      white-space: nowrap;
    }

    button:active {
      transform: scale(0.97);
    }

    .btn-primary {
      flex: 2;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: #fff;
      box-shadow: 0 6px 14px rgba(25, 118, 210, 0.4);
    }

    #submit-btn {
      padding: 20px 14px;
      min-height: 2.8em;
    }

    .btn-primary:disabled {
      opacity: 0.55;
      box-shadow: none;
      cursor: default;
    }

    .btn-secondary {
      flex: 1.3;
      background: #f1f6ff;
      color: var(--primary);
      border: 1px solid rgba(25, 118, 210, 0.18);
      box-shadow: 0 4px 10px rgba(13, 71, 161, 0.08);
    }

    .btn-secondary:disabled {
      opacity: 0.4;
      box-shadow: none;
      cursor: default;
    }

    .feedback {
      min-height: 40px;
      margin-top: 6px;
      font-size: 0.9rem;
      line-height: 1.5;
      border-radius: 12px;
      padding: 8px 10px;
      background: #f7fbff;
      color: var(--muted);
    }

    .feedback.correct {
      background: #e8f5e9;
      color: var(--success);
    }

    .feedback.incorrect {
      background: #ffebee;
      color: var(--danger);
    }

    .feedback-title {
      font-weight: 600;
      margin-right: 4px;
    }

    .batch-summary {
      margin-top: 6px;
      font-size: 0.85rem;
      color: var(--muted);
      border-top: 1px dashed rgba(96, 125, 139, 0.35);
      padding-top: 6px;
    }

    .batch-summary strong {
      color: var(--text-main);
    }

    .recent-card {
      margin-top: 10px;
      padding: 12px 14px 10px;
      background: #ffffff;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-soft);
      font-size: 0.82rem;
    }

    .recent-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      color: var(--muted);
    }

    .recent-title {
      font-weight: 600;
      color: var(--text-main);
      font-size: 0.86rem;
    }

    .recent-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    .recent-table th,
    .recent-table td {
      padding: 4px 2px;
      text-align: center;
      border-bottom: 1px solid #e3edf7;
      white-space: nowrap;
    }

    .recent-table th {
      font-weight: 600;
      color: var(--muted);
      font-size: 0.78rem;
    }

    .recent-table td:first-child {
      text-align: left;
    }

    .recent-empty {
      margin-top: 4px;
      font-size: 0.78rem;
      color: var(--muted);
    }

    .game-over-panel {
      margin-top: 14px;
      padding: 16px;
      background: #f5f9ff;
      border-radius: var(--border-radius);
      border: 1px solid rgba(25, 118, 210, 0.2);
      text-align: center;
    }

    .game-over-title {
      margin: 0 0 12px;
      font-size: 1.3rem;
      color: var(--primary);
    }

    .game-over-line {
      margin: 6px 0;
      font-size: 0.9rem;
      color: var(--text-main);
    }

    .game-over-best {
      color: var(--muted);
      font-size: 0.85rem;
    }

    .app-footer {
      margin-top: 10px;
      font-size: 0.76rem;
      text-align: center;
      color: var(--muted);
    }

    .home-section {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .home-total-score {
      padding: 10px 16px;
      background: linear-gradient(135deg, #e3f2fd, #f5f9ff);
      border-radius: 10px;
      font-size: 0.95rem;
      color: var(--text-main);
      text-align: center;
    }
    .home-total-score strong { color: var(--primary); }

    .mode-btn {
      width: 100%;
      padding: 16px 20px;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      font-family: inherit;
      transition: transform 0.08s ease, box-shadow 0.12s ease;
      text-align: center;
    }

    .mode-btn:active {
      transform: scale(0.98);
    }

    .mode-btn-survival {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: #fff;
      box-shadow: 0 6px 14px rgba(25, 118, 210, 0.4);
    }

    .mode-btn-level {
      background: linear-gradient(135deg, #2e7d32, #4caf50);
      color: #fff;
      box-shadow: 0 6px 14px rgba(46, 125, 50, 0.35);
    }

    .mode-btn-practice {
      background: linear-gradient(135deg, #7b1fa2, #9c27b0);
      color: #fff;
      box-shadow: 0 6px 14px rgba(123, 31, 162, 0.35);
    }

    .mode-btn-wrongbook {
      background: linear-gradient(135deg, #e65100, #ff9800);
      color: #fff;
      box-shadow: 0 6px 14px rgba(230, 81, 0, 0.35);
    }

    .mode-btn-disabled {
      background: #e0e0e0;
      color: #9e9e9e;
      box-shadow: none;
      cursor: not-allowed;
    }

    .wrongbook-section {
      margin-top: 16px;
    }
    .wrongbook-header { margin-bottom: 12px; }
    .wrongbook-title { margin: 0 0 4px; font-size: 1.2rem; color: #e65100; }
    .wrongbook-subtitle { margin: 0; font-size: 0.88rem; color: var(--muted); }
    .wrongbook-list {
      background: #fff;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-soft);
      padding: 12px 16px;
      margin-bottom: 12px;
      max-height: 400px;
      overflow-y: auto;
    }
    .wrongbook-item {
      padding: 10px 0;
      border-bottom: 1px solid #eee;
      font-size: 0.95rem;
    }
    .wrongbook-item:last-child { border-bottom: none; }
    .wrongbook-item .q { font-weight: 600; color: var(--text-main); margin-bottom: 4px; }
    .wrongbook-item .wrong-ans { color: var(--danger); }
    .wrongbook-item .correct-ans { color: var(--success); }
    .wrongbook-empty { text-align: center; padding: 24px; color: var(--muted); }
    .wrongbook-actions { display: flex; flex-direction: column; gap: 10px; }

    .game-section {
      display: none;
    }

    .game-section.visible {
      display: block;
    }

    .game-section .subtitle {
      margin-top: 8px;
    }

    .home-section.hidden {
      display: none;
    }

    .game-over-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 14px;
    }

    .game-over-buttons .btn-primary {
      flex: none;
    }

    @media (min-width: 768px) {
      .app {
        padding: 20px 24px;
      }

      .card {
        padding: 20px 24px 18px;
      }

      .app-title {
        font-size: 1.7rem;
      }
    }
  </style>
</head>
<body>
  <div id="login-view" class="login-view">
    <div class="login-card">
      <h1 class="login-title">Jarvis Math Lab 计算游戏</h1>
      <p class="login-subtitle">请先登录学员账号再开始练习（账号由老师在后台创建）。</p>
      <div class="login-field">
        <input id="login-username" type="text" autocomplete="username" placeholder="用户名" />
      </div>
      <div class="login-field">
        <input id="login-password" type="password" autocomplete="current-password" placeholder="密码" />
      </div>
      <button id="login-btn" class="login-btn">登录</button>
      <button id="guest-btn" class="login-btn guest-btn">游客试玩</button>
      <div id="login-error" class="login-error"></div>
      <p class="login-hint">本练习无法自行注册，请联系尤老师获取账号与密码。也可先游客试玩，数据仅保存在本机。登录后记录将同步到服务器。</p>
      <p class="login-version">版本 v1.4.0</p><!-- 与页脚版本号保持一致 -->
    </div>
  </div>

  <div class="app" id="app-view" style="display:none;">
    <header class="app-header">
      <h1 class="app-title">Jarvis Math Lab 计算游戏</h1>
      <div class="user-bar">
        <span>当前学员：<span class="user-name" id="current-username-label">-</span></span>
        <button id="logout-btn" class="logout-btn">注销</button>
      </div>
    </header>

    <section class="home-section" id="home-section">
      <div class="home-total-score" id="home-total-score"></div>
      <button type="button" class="mode-btn mode-btn-survival" id="mode-survival">生存挑战</button>
      <button type="button" class="mode-btn mode-btn-level" id="mode-level">闯关挑战</button>
      <button type="button" class="mode-btn mode-btn-practice" id="mode-practice">训练模式</button>
      <button type="button" class="mode-btn mode-btn-wrongbook" id="mode-wrongbook">错题本</button>
    </section>

    <div class="game-section" id="game-section">
      <p class="subtitle" id="game-subtitle">生存挑战：从 L1 开始，答对加 2 秒并得分（L1=1 分…L16=16 分），连续对 5 题升级、错 1 题降级，看你能撑多久！</p>

      <div class="status-grid" id="status-grid">
        <div class="status-item status-item-full">
          <span class="status-label">当前难度</span>
          <span class="status-value" id="current-level-name">-</span>
        </div>
        <div class="status-item" id="status-row-2">
          <span class="status-label" id="status-label-2">连续答对</span>
          <span class="status-value" id="consecutive-correct">0 / 5</span>
        </div>
        <div class="status-item" id="status-row-3">
          <span class="status-label" id="status-label-3">本局得分</span>
          <span class="status-value" id="run-score">0</span>
        </div>
        <div class="status-item" id="status-row-4">
          <span class="status-label" id="status-label-4">个人最佳时间</span>
          <span class="status-value" id="best-survival-time">-</span>
        </div>
        <div class="status-item" id="status-row-5">
          <span class="status-label" id="status-label-5">个人最高得分</span>
          <span class="status-value" id="best-score">-</span>
        </div>
      </div>

    <main class="card" id="game-card">
      <div class="question-header">
        <div class="question-label">当前题目</div>
        <div class="timer-chip" id="timer-chip">
          剩余 <span id="timer-value">1:00</span>
        </div>
      </div>

      <div class="question-text" id="question-text">0 + 0 = ?</div>
      <div class="question-subtext" id="question-subtext"></div>

      <form id="answer-form" class="answer-form" action="javascript:void(0);">
        <div class="input-row" id="answer-input-row" style="display:none">
          <input id="answer-input" type="number" inputmode="numeric" pattern="\d*" autocomplete="off" placeholder="在这里输入你的答案" enterkeyhint="go" />
        </div>
        <div class="button-row">
          <button type="submit" class="btn-primary" id="submit-btn">提交答案</button>
          <button type="button" class="btn-primary" id="start-game-btn">开始游戏</button>
        </div>
        <div class="game-back-row" id="game-back-row">
          <button type="button" class="btn-primary btn-secondary" id="game-back-home-btn">返回首页</button>
        </div>
      </form>

      <div class="feedback" id="feedback"></div>
      <div class="batch-summary" id="batch-summary"></div>

      <div id="game-over-panel" class="game-over-panel" style="display:none;">
        <h2 class="game-over-title" id="game-over-title">Game Over</h2>
        <p class="game-over-line">本局存活：<strong id="game-over-duration">-</strong></p>
        <p class="game-over-line">本局得分：<strong id="game-over-score">0</strong></p>
        <p class="game-over-line">本局错题：<strong id="game-over-wrong">0</strong></p>
        <p class="game-over-line">到达最高难度：<strong id="game-over-max-level">-</strong></p>
        <p class="game-over-line game-over-best">个人最佳：<span id="game-over-best-time">-</span> · 最高得分 <span id="game-over-best-score">-</span></p>
        <div class="game-over-buttons">
          <button class="btn-primary" id="play-again-btn">再玩一局</button>
          <button class="btn-primary btn-secondary" id="back-home-btn">返回首页</button>
        </div>
      </div>
    </main>

    <section class="recent-card">
      <div class="recent-header">
        <span class="recent-title" id="recent-title">最近十次生存挑战</span>
      </div>
      <div class="recent-body">
        <table class="recent-table">
          <thead>
            <tr>
              <th>存活时长</th>
              <th>得分</th>
              <th>错误题数</th>
              <th>最高难度</th>
              <th>日期时间</th>
            </tr>
          </thead>
          <tbody id="recent-history-body"></tbody>
        </table>
        <div id="recent-history-empty" class="recent-empty">当前还没有练习记录。</div>
      </div>
    </section>
    </div>

    <section class="wrongbook-section" id="wrongbook-section" style="display:none;">
      <div class="wrongbook-header">
        <h2 class="wrongbook-title">错题本</h2>
        <p class="wrongbook-subtitle">以下是最近 20 条错题，可自行复习。</p>
      </div>
      <div class="wrongbook-list" id="wrongbook-list"></div>
      <div id="wrongbook-empty" class="wrongbook-empty">暂无错题记录。</div>
      <div class="wrongbook-actions" id="wrongbook-actions">
        <button type="button" class="btn-primary" id="wrongbook-practice-btn" style="display:none;">错题练习</button>
        <button type="button" class="btn-primary btn-secondary" id="wrongbook-back-btn">回到首页</button>
      </div>
    </section>

    <footer class="app-footer">
      本页面为单文件 H5，自适应手机与电脑访问。登录后数据同步至服务器，换设备可继续练习。<br>
      <!-- 每次修改代码后请同步更新此处及登录页的版本号 -->
      <strong>版本 v1.4.0</strong>
    </footer>
  </div>

  <script>
    // ====== 后台管理面板（Admin Panel）DOM ======
    // 管理面板插入到body最底部
    document.addEventListener("DOMContentLoaded", function() {
      loadAdminAuth();
      const adminPanel = document.createElement("div");
      adminPanel.id = "admin-panel";
      adminPanel.style = "display:none;position:fixed;left:0;top:0;width:100vw;height:100vh;padding-top:62px;z-index:1000;background:#FFF;overflow:auto;";
      adminPanel.innerHTML = `
        <div style="max-width:520px;margin:auto;background:#f8f8fc;border-radius:10px;padding:16px 18px;">
        <h2>后台管理（难度与练习设置）</h2>
        <form id="admin-form">
        <table style="border-collapse:collapse;width:100%;margin-top:10px;">
          <thead>
            <tr style="border-bottom:1px solid #e2e2e2;">
              <th>难度名称</th>
              <th>及格准确率 %</th>
              <th>通关准确率 %</th>
              <th>通关时限(秒)</th>
            </tr>
          </thead>
          <tbody id="admin-table-body"></tbody>
        </table>
        <div style="margin-top:18px;margin-bottom:5px;">
          <button id="admin-save-btn" type="submit" style="padding:6px 18px;margin-right:12px;">保存设置</button>
          <button id="admin-close-btn" type="button" style="padding:6px 18px;">关闭返回</button>
          <span id="admin-save-tip" style="margin-left:12px;color:#090;"></span>
        </div>
        </form>
        </div>
      `;
      document.body.appendChild(adminPanel);

      document.getElementById("admin-close-btn").addEventListener("click", function() {
        adminPanel.style.display = "none";
      });
      document.getElementById("admin-form").addEventListener("submit", function(e) {
        e.preventDefault();
        saveAdminSettings();
        document.getElementById("admin-save-tip").textContent = "已保存！";
        setTimeout(()=>{document.getElementById("admin-save-tip").textContent="";},1300);
      });

      function renderAdminTable() {
        const tbody = document.getElementById("admin-table-body");
        const settings = loadCustomSettings();
        tbody.innerHTML = "";
        for (let i = 0; i < DIFFICULTY_MODULE.levels.length; i++) {
          const lvl = DIFFICULTY_MODULE.levels[i];
          const s = settings.levels[i] || {};
          tbody.innerHTML += `
            <tr>
              <td style="text-align:left;font-weight:500">${lvl.name}</td>
              <td>
                <input type="number" min="10" max="100" step="1" required style="width:56px" name="passAccuracy${i}" value="${Math.round((s.passAccuracy ?? DEFAULT_LEVEL_CONFIGS[i].passAccuracy)*100)}"/>
              </td>
              <td>
                <input type="number" min="10" max="100" step="1" required style="width:56px" name="accuracy${i}" value="${Math.round((s.upgradeAccuracy ?? DEFAULT_LEVEL_CONFIGS[i].upgradeAccuracy)*100)}"/>
              </td>
              <td>
                <input type="number" min="30" max="1200" required style="width:66px" name="timelimit${i}" value="${s.upgradeTimeLimit||DEFAULT_LEVEL_CONFIGS[i].upgradeTimeLimit}" />
              </td>
            </tr>
          `;
        }
      }

      function saveAdminSettings() {
        const form = document.getElementById("admin-form");
        const newLevels = [];
        for (let i = 0; i < DIFFICULTY_MODULE.levels.length; i++) {
          const passAccuracy = Number(form["passAccuracy"+i].value) / 100;
          const upgradeAccuracy = Number(form["accuracy"+i].value) / 100;
          const upgradeTimeLimit = Number(form["timelimit"+i].value);
          newLevels.push({passAccuracy, upgradeAccuracy, upgradeTimeLimit});
        }
        const newSettings = { levels: newLevels };
        cachedGameSettings = newSettings;
        localStorage.setItem(ADMIN_SETTINGS_KEY, JSON.stringify(newSettings));
        const base = getApiBase();
        if (base && adminAuthed) {
          fetch(base + "/api/admin/settings", {
            method: "PUT",
            headers: { "Content-Type": "application/json", "X-Admin-Pin": ADMIN_PIN },
            body: JSON.stringify(newSettings)
          }).catch(function(e) { console.warn("同步设置到服务器失败", e); });
        }
      }
    });

    // ===== 管理配置默认值&Key =====
    const ADMIN_SETTINGS_KEY = "adaptive_math_admin_settings_v1";
    let cachedGameSettings = null;
    const DEFAULT_LEVEL_CONFIGS = [
      { passAccuracy: 0.8, upgradeAccuracy: 0.95, upgradeTimeLimit: 300 }, // L1
      { passAccuracy: 0.8, upgradeAccuracy: 0.95, upgradeTimeLimit: 300 }, // L2
      { passAccuracy: 0.8, upgradeAccuracy: 0.95, upgradeTimeLimit: 300 }, // L3
      { passAccuracy: 0.8, upgradeAccuracy: 0.95, upgradeTimeLimit: 300 }, // L4
      { passAccuracy: 0.8, upgradeAccuracy: 0.95, upgradeTimeLimit: 330 }, // L5
      { passAccuracy: 0.8, upgradeAccuracy: 0.95, upgradeTimeLimit: 330 }, // L6
      { passAccuracy: 0.8, upgradeAccuracy: 0.95, upgradeTimeLimit: 360 }, // L7
      { passAccuracy: 0.8, upgradeAccuracy: 0.95, upgradeTimeLimit: 360 }, // L8
      { passAccuracy: 0.8, upgradeAccuracy: 0.95, upgradeTimeLimit: 420 }, // L9
      { passAccuracy: 0.8, upgradeAccuracy: 0.95, upgradeTimeLimit: 360 }, // L10
      { passAccuracy: 0.8, upgradeAccuracy: 0.95, upgradeTimeLimit: 420 }, // L11
      { passAccuracy: 0.8, upgradeAccuracy: 0.95, upgradeTimeLimit: 360 }, // L12
      { passAccuracy: 0.8, upgradeAccuracy: 0.95, upgradeTimeLimit: 420 }, // L13
      { passAccuracy: 0.8, upgradeAccuracy: 0.95, upgradeTimeLimit: 420 }, // L14
      { passAccuracy: 0.8, upgradeAccuracy: 0.95, upgradeTimeLimit: 480 }, // L15
      { passAccuracy: 0.8, upgradeAccuracy: 0.95, upgradeTimeLimit: 480 }, // L16
    ];

    // ===== 后台访问口令与登录状态（仅前端保护，防止普通学生误进）=====
    const ADMIN_PIN = "2026"; // TODO：改成你自己的后台访问口令
    const ADMIN_AUTH_KEY = "adaptive_math_admin_authed_v1";
    let adminAuthed = false;

    function loadAdminAuth() {
      try {
        adminAuthed = localStorage.getItem(ADMIN_AUTH_KEY) === "1";
      } catch (e) {
        adminAuthed = false;
      }
    }

    function saveAdminAuth() {
      try {
        localStorage.setItem(ADMIN_AUTH_KEY, adminAuthed ? "1" : "0");
      } catch (e) {
        // ignore
      }
    }

    async function refreshGameSettings() {
      const base = getApiBase();
      if (base) {
        try {
          const res = await fetch(base + "/api/settings");
          const data = await res.json();
          if (data.ok && data.settings && Array.isArray(data.settings.levels)) {
            cachedGameSettings = data.settings;
            return;
          }
        } catch (e) {
          console.warn("从服务器加载难度设置失败，使用本地缓存", e);
        }
      }
      try {
        const raw = localStorage.getItem(ADMIN_SETTINGS_KEY);
        if (raw) {
          const obj = JSON.parse(raw);
          if (obj && obj.levels && Array.isArray(obj.levels))
            cachedGameSettings = obj;
        }
      } catch (e) { /* ignore */ }
      if (!cachedGameSettings) cachedGameSettings = { levels: [] };
    }

    function loadCustomSettings() {
      if (cachedGameSettings) return cachedGameSettings;
      try {
        const data = localStorage.getItem(ADMIN_SETTINGS_KEY);
        if (!data) return {levels: []};
        const obj = JSON.parse(data);
        if (obj && obj.levels && Array.isArray(obj.levels))
          return obj;
        return {levels: []};
      } catch(e) {
        return {levels: []};
      }
    }

    function getLevelSetting(idx) {
      const set = loadCustomSettings();
      const def = DEFAULT_LEVEL_CONFIGS[idx] || DEFAULT_LEVEL_CONFIGS[0];
      if (!set.levels[idx]) return def;
      return {
        passAccuracy: typeof set.levels[idx].passAccuracy==="number" ? set.levels[idx].passAccuracy : def.passAccuracy,
        upgradeAccuracy: typeof set.levels[idx].upgradeAccuracy==="number" ? set.levels[idx].upgradeAccuracy : def.upgradeAccuracy,
        upgradeTimeLimit: set.levels[idx].upgradeTimeLimit || def.upgradeTimeLimit
      };
    }

    // ===== 难度模块定义 =====
    const DIFFICULTY_MODULE = {
      levels: [
        {
          id: "L1",
          name: "第 1 级 · 一位数加法入门",
          description: "9 以内一位数加法，无进位为主，适合作为热身。",
          operations: ["+"],
          min: 1,
          max: 9,
          generateQuestion() {
            const a = randomInt(this.min, this.max);
            let bMax = this.max;
            if (Math.random() < 0.7) {
              bMax = Math.min(this.max, 9 - a);
            }
            const b = randomInt(this.min, Math.max(this.min, bMax));
            const answer = a + b;
            const text = `${a} + ${b} = ?`;
            return { a, b, op: "+", text, answer, baseLevelId: this.id };
          }
        },
        {
          id: "L2",
          name: "第 2 级 · 一位数加法进阶",
          description: "一位数加法，包含进位，熟练 10 以内凑整。",
          operations: ["+"],
          min: 2,
          max: 9,
          generateQuestion() {
            const a = randomInt(this.min, this.max);
            let b;
            if (a <= 4) {
              b = randomInt(6, this.max);
            } else {
              const minB = Math.max(this.min, 10 - a);
              b = randomInt(minB, this.max);
            }
            const answer = a + b;
            const text = `${a} + ${b} = ?`;
            return { a, b, op: "+", text, answer, baseLevelId: this.id };
          }
        },
        {
          id: "L3",
          name: "第 3 级 · 一位数加减混合",
          description: "9 以内加减混合，巩固“凑整”和“退整”的概念。",
          operations: ["+", "-"],
          min: 1,
          max: 9,
          generateQuestion() {
            const op = Math.random() < 0.5 ? "+" : "-";
            let a, b, answer;
            if (op === "+") {
              a = randomInt(this.min, this.max);
              const minB = Math.max(this.min, 10 - a);
              b = randomInt(minB, this.max);
              answer = a + b;
            } else {
              a = randomInt(4, this.max);
              b = randomInt(this.min, Math.min(a, 9));
              answer = a - b;
            }
            const text = `${a} ${op} ${b} = ?`;
            return { a, b, op, text, answer, baseLevelId: this.id };
          }
        },
        {
          id: "L4",
          name: "第 4 级 · 两位数加减基础",
          description: "20 以内两位数加减，包含简单进退位，迈向笔算。",
          operations: ["+", "-"],
          min: 6,
          max: 20,
          generateQuestion() {
            const op = Math.random() < 0.5 ? "+" : "-";
            let a, b, answer;
            if (op === "+") {
              a = randomInt(6, 15);
              b = randomInt(4, 9);
              answer = a + b;
            } else {
              a = randomInt(11, 20);
              b = randomInt(2, 9);
              if (a % 10 >= b && Math.random() < 0.4) {
                // no-op
              } else {
                const tenPart = Math.floor(a / 10) * 10;
                const unit = randomInt(0, 4);
                a = tenPart + unit;
                b = randomInt(unit + 1, 9);
              }
              answer = a - b;
            }
            const text = `${a} ${op} ${b} = ?`;
            return { a, b, op, text, answer, baseLevelId: this.id };
          }
        },
        {
          id: "L5",
          name: "第 5 级 · 两位数加一位数/整十数",
          description: "两位数加一位数或整十数，整十数巩固位值，一位数侧重进位。",
          operations: ["+"],
          min: 20,
          max: 99,
          generateQuestion() {
            let a, b, answer;
            a = randomInt(20, 99);
            if (Math.random() < 0.4) {
              b = randomInt(1, 9) * 10;
            } else {
              if (Math.random() < 0.75) {
                const aUnit = a % 10;
                const minB = Math.max(4, 10 - aUnit);
                b = randomInt(minB, 9);
              } else {
                b = randomInt(4, 9);
              }
            }
            answer = a + b;
            const text = `${a} + ${b} = ?`;
            return { a, b, op: "+", text, answer, baseLevelId: this.id };
          }
        },
        {
          id: "L6",
          name: "第 6 级 · 两位数减一位数/整十数",
          description: "两位数减一位数或整十数，整十数巩固位值，一位数侧重退位。",
          operations: ["-"],
          min: 20,
          max: 99,
          generateQuestion() {
            let a, b, answer;
            if (Math.random() < 0.4) {
              a = randomInt(20, 99);
              const maxTen = Math.floor(a / 10);
              b = randomInt(1, maxTen) * 10;
            } else {
              if (Math.random() < 0.75) {
                const ten = randomInt(2, 9);
                const unitA = randomInt(0, 7);
                b = randomInt(unitA + 1, 9);
                a = ten * 10 + unitA;
              } else {
                b = randomInt(2, 9);
                const unitA = randomInt(b, 9);
                const ten = randomInt(2, 9);
                a = ten * 10 + unitA;
              }
            }
            answer = a - b;
            const text = `${a} - ${b} = ?`;
            return { a, b, op: "-", text, answer, baseLevelId: this.id };
          }
        },
        {
          id: "L7",
          name: "第 7 级 · 两位数加两位数（进位）",
          description: "两位数加两位数，进位为主，结果不超过 100，与 L8 衔接。",
          operations: ["+"],
          min: 10,
          max: 99,
          generateQuestion() {
            let a, b, answer;
            a = randomInt(10, 80);
            const maxB = 100 - a;
            if (Math.random() < 0.8) {
              const aUnit = a % 10;
              const minUnitB = Math.max(1, 10 - aUnit);
              const maxUnitB = Math.min(9, maxB - 10);
              if (maxUnitB >= minUnitB) {
                const unitB = randomInt(minUnitB, maxUnitB);
                const maxTenB = Math.floor((maxB - unitB) / 10);
                const tenB = randomInt(1, Math.max(1, maxTenB));
                b = tenB * 10 + unitB;
              } else {
                b = randomInt(10, maxB);
              }
            } else {
              b = randomInt(10, Math.min(99, maxB));
            }
            if (b < 10) b = 10;
            if (a + b > 100) b = 100 - a;
            answer = a + b;
            const text = `${a} + ${b} = ?`;
            return { a, b, op: "+", text, answer, baseLevelId: this.id };
          }
        },
        {
          id: "L8",
          name: "第 8 级 · 两位数减两位数（退位）",
          description: "两位数减两位数，退位为主，巩固“借一当十”。",
          operations: ["-"],
          min: 20,
          max: 99,
          generateQuestion() {
            let a, b, answer;
            if (Math.random() < 0.8) {
              const ten = randomInt(3, 9);
              const unitA = randomInt(0, 8);
              const unitB = randomInt(unitA + 1, 9);
              a = ten * 10 + unitA;
              b = randomInt(1, ten - 1) * 10 + unitB;
            } else {
              a = randomInt(20, 99);
              b = randomInt(10, a - 1);
            }
            if (b > a) [a, b] = [b, a];
            answer = a - b;
            const text = `${a} - ${b} = ?`;
            return { a, b, op: "-", text, answer, baseLevelId: this.id };
          }
        },
        {
          id: "L9",
          name: "第 9 级 · 两位数加减混合",
          description: "两位数加减混合，进位与退位交替出现，结果不超过 100。",
          operations: ["+", "-"],
          min: 10,
          max: 99,
          generateQuestion() {
            const op = Math.random() < 0.5 ? "+" : "-";
            let a, b, answer;
            if (op === "+") {
              a = randomInt(10, 80);
              const maxB = 100 - a;
              const aUnit = a % 10;
              const minUnitB = Math.max(1, 10 - aUnit);
              const maxUnitB = Math.min(9, maxB - 10);
              if (Math.random() < 0.7 && maxUnitB >= minUnitB) {
                const unitB = randomInt(minUnitB, maxUnitB);
                const maxTenB = Math.floor((maxB - unitB) / 10);
                const tenB = randomInt(1, Math.max(1, maxTenB));
                b = tenB * 10 + unitB;
              } else {
                b = randomInt(10, Math.min(99, maxB));
              }
              if (b < 10) b = 10;
              if (a + b > 100) b = 100 - a;
              answer = a + b;
            } else {
              // 倾向出现退位
              if (Math.random() < 0.7) {
                const ten = randomInt(3, 9);
                const unitA = randomInt(0, 8);
                const unitB = randomInt(unitA + 1, 9);
                a = ten * 10 + unitA;
                b = randomInt(1, ten - 1) * 10 + unitB;
              } else {
                a = randomInt(20, 99);
                b = randomInt(10, a - 1);
              }
              if (b > a) [a, b] = [b, a];
              answer = a - b;
            }
            const text = `${a} ${op} ${b} = ?`;
            return { a, b, op, text, answer, baseLevelId: this.id };
          }
        },
        {
          id: "L10",
          name: "第 10 级 · 乘法口诀基础",
          description: "1 到 9 的乘法口诀，打牢乘法基础。",
          operations: ["×"],
          min: 1,
          max: 9,
          generateQuestion() {
            const a = randomInt(this.min, this.max);
            const b = randomInt(this.min, this.max);
            const answer = a * b;
            const text = `${a} × ${b} = ?`;
            return { a, b, op: "×", text, answer, baseLevelId: this.id };
          }
        },
        {
          id: "L11",
          name: "第 11 级 · 两位除一位整除",
          description: "两位数除以一位数，结果为整数，巩固乘除互逆（乘法口诀的逆运算）。",
          operations: ["÷"],
          min: 2,
          max: 9,
          generateQuestion() {
            const divisor = randomInt(this.min, this.max);
            const quotient = randomInt(2, 9);
            const dividend = divisor * quotient;
            const answer = quotient;
            const text = `${dividend} ÷ ${divisor} = ?`;
            return { a: dividend, b: divisor, op: "÷", text, answer, baseLevelId: this.id };
          }
        },
        {
          id: "L12",
          name: "第 12 级 · 两位数加两位数（结果超100）",
          description: "两位数加两位数，结果超过 100，引入三位数，衔接乘法。",
          operations: ["+"],
          min: 10,
          max: 99,
          generateQuestion() {
            let a, b, answer;
            a = randomInt(10, 99);
            const minB = Math.max(10, 101 - a);
            if (Math.random() < 0.8) {
              const aUnit = a % 10;
              const minUnitB = Math.max(1, 10 - aUnit);
              const unitB = randomInt(minUnitB, 9);
              const needTenB = Math.ceil((minB - unitB) / 10);
              const maxTenB = Math.floor((99 - unitB) / 10);
              if (maxTenB >= needTenB) {
                const tenB = randomInt(needTenB, maxTenB);
                b = tenB * 10 + unitB;
              } else {
                b = randomInt(minB, 99);
              }
            } else {
              b = randomInt(minB, 99);
            }
            answer = a + b;
            const text = `${a} + ${b} = ?`;
            return { a, b, op: "+", text, answer, baseLevelId: this.id };
          }
        },
        {
          id: "L13",
          name: "第 13 级 · 两位乘一位",
          description: "两位数乘一位数，结果不超过 100，为多位数乘法竖式打基础。",
          operations: ["×"],
          min: 2,
          max: 9,
          generateQuestion() {
            let a, b, answer;
            b = randomInt(this.min, this.max);
            const maxA = Math.floor(99 / b);
            const minA = 11;
            a = maxA >= minA ? randomInt(minA, maxA) : minA;
            answer = a * b;
            const text = `${a} × ${b} = ?`;
            return { a, b, op: "×", text, answer, baseLevelId: this.id };
          }
        },
        {
          id: "L14",
          name: "第 14 级 · 两位乘一位的逆运算",
          description: "两位数或三位数除以一位数，商为两位数，对应两位乘一位的除法。",
          operations: ["÷"],
          min: 2,
          max: 9,
          generateQuestion() {
            const divisor = randomInt(this.min, this.max);
            const quotient = randomInt(11, 99);
            const dividend = divisor * quotient;
            const answer = quotient;
            const text = `${dividend} ÷ ${divisor} = ?`;
            return { a: dividend, b: divisor, op: "÷", text, answer, baseLevelId: this.id };
          }
        },
        {
          id: "L15",
          name: "第 15 级 · 不带括号的四则运算",
          description: "3 个数 2 个运算符，先乘除后加减，单步难度至 L11。",
          operations: ["+", "-", "×", "÷"],
          min: 1,
          max: 99,
          generateQuestion() {
            const templates = [
              () => { const b = randomInt(1, 9); const c = randomInt(1, 9); const a = randomInt(0, Math.min(99, 100 - b * c)); return { text: `${a} + ${b} × ${c} = ?`, answer: a + b * c }; },
              () => { const a = randomInt(1, 9); const b = randomInt(1, 9); const c = randomInt(0, Math.min(99, 100 - a * b)); return { text: `${a} × ${b} + ${c} = ?`, answer: a * b + c }; },
              () => { const c = randomInt(2, 9); const b = c * randomInt(2, 9); if (b > 81) return null; const a = randomInt(0, Math.min(99, 100 - b / c)); return { text: `${a} + ${b} ÷ ${c} = ?`, answer: a + b / c }; },
              () => { const b = randomInt(2, 9); const a = b * randomInt(2, 9); if (a > 81) return null; const c = randomInt(0, Math.min(99, 100 - a / b)); return { text: `${a} ÷ ${b} + ${c} = ?`, answer: a / b + c }; },
              () => { const b = randomInt(1, 9); const c = randomInt(1, 9); const a = randomInt(b * c, Math.min(99, 100)); return { text: `${a} − ${b} × ${c} = ?`, answer: a - b * c }; },
              () => { const a = randomInt(1, 9); const b = randomInt(1, 9); const c = randomInt(0, a * b); return { text: `${a} × ${b} − ${c} = ?`, answer: a * b - c }; },
              () => { const c = randomInt(2, 9); const b = c * randomInt(2, 9); if (b > 81) return null; const a = randomInt(b / c, 99); return { text: `${a} − ${b} ÷ ${c} = ?`, answer: a - b / c }; },
              () => { const b = randomInt(2, 9); const a = b * randomInt(2, 9); if (a > 81) return null; const c = randomInt(0, a / b); return { text: `${a} ÷ ${b} − ${c} = ?`, answer: a / b - c }; },
              () => { const a = randomInt(0, 50); const b = randomInt(0, Math.min(50, 100 - a)); const c = randomInt(0, Math.min(50, 100 - a - b)); return { text: `${a} + ${b} + ${c} = ?`, answer: a + b + c }; },
              () => { const a = randomInt(20, 99); const b = randomInt(0, Math.min(50, a)); const c = randomInt(0, Math.min(50, a - b)); return { text: `${a} − ${b} − ${c} = ?`, answer: a - b - c }; },
              () => { const a = randomInt(1, 4); const b = randomInt(1, 4); const c = randomInt(1, Math.min(4, Math.floor(81 / (a * b)))); return { text: `${a} × ${b} × ${c} = ?`, answer: a * b * c }; },
              () => { const c = randomInt(2, 9); const b = randomInt(2, 9); const a = b * c * randomInt(1, 4); if (a > 81) return null; return { text: `${a} ÷ ${b} ÷ ${c} = ?`, answer: a / b / c }; },
              () => { const a = randomInt(1, 9); const b = randomInt(1, 9); const c = randomInt(2, 9); if ((a * b) % c !== 0) return null; return { text: `${a} × ${b} ÷ ${c} = ?`, answer: a * b / c }; },
              () => { const b = randomInt(2, 9); const a = b * randomInt(2, 9); if (a > 81) return null; const c = randomInt(1, 9); return { text: `${a} ÷ ${b} × ${c} = ?`, answer: a / b * c }; },
              () => { const a = randomInt(0, 50); const b = randomInt(0, 50); const c = randomInt(0, Math.min(99, a + b)); return { text: `${a} + ${b} − ${c} = ?`, answer: a + b - c }; },
              () => { const a = randomInt(10, 99); const b = randomInt(0, a); const c = randomInt(0, 99); return { text: `${a} − ${b} + ${c} = ?`, answer: a - b + c }; }
            ];
            for (let i = 0; i < 20; i++) {
              const t = templates[randomInt(0, templates.length - 1)];
              const r = t();
              if (r && Number.isInteger(r.answer) && r.answer >= 0) return { a: 0, b: 0, op: "+", text: r.text, answer: r.answer, baseLevelId: this.id };
            }
            const fallback = templates[0]();
            return { a: 0, b: 0, op: "+", text: (fallback && fallback.text) || "1 + 2 + 3 = ?", answer: (fallback && fallback.answer) || 6, baseLevelId: this.id };
          }
        },
        {
          id: "L16",
          name: "第 16 级 · 带括号的四则运算",
          description: "3 个数 2 个运算符，一对括号改变运算顺序，单步难度至 L11。",
          operations: ["+", "-", "×", "÷"],
          min: 1,
          max: 99,
          generateQuestion() {
            const templates = [
              () => { const a = randomInt(1, 8); const b = randomInt(1, 9 - a); const c = randomInt(1, 9); return { text: `(${a} + ${b}) × ${c} = ?`, answer: (a + b) * c }; },
              () => { const a = randomInt(2, 9); const b = randomInt(1, a - 1); const c = randomInt(1, 9); return { text: `(${a} − ${b}) × ${c} = ?`, answer: (a - b) * c }; },
              () => { const c = randomInt(2, 9); const quotient = randomInt(2, 9); const sum = c * quotient; if (sum < 10 || sum > 18) return null; const a = randomInt(1, sum - 1); const b = sum - a; return { text: `(${a} + ${b}) ÷ ${c} = ?`, answer: (a + b) / c }; },
              () => { const a = randomInt(2, 9); const b = randomInt(1, a - 1); const c = randomInt(2, 9); if ((a - b) % c !== 0) return null; return { text: `(${a} − ${b}) ÷ ${c} = ?`, answer: (a - b) / c }; },
              () => { const a = randomInt(1, 9); const b = randomInt(1, 8); const c = randomInt(1, 9 - b); return { text: `${a} × (${b} + ${c}) = ?`, answer: a * (b + c) }; },
              () => { const a = randomInt(1, 9); const b = randomInt(2, 9); const c = randomInt(1, b - 1); return { text: `${a} × (${b} − ${c}) = ?`, answer: a * (b - c) }; },
              () => { const bc = randomInt(2, 9); const a = bc * randomInt(2, 9); if (a > 81) return null; const b = randomInt(1, bc - 1); const c = bc - b; return { text: `${a} ÷ (${b} + ${c}) = ?`, answer: a / (b + c) }; },
              () => { const bc = randomInt(2, 9); const a = bc * randomInt(2, 9); if (a > 81) return null; const b = randomInt(bc + 1, 9); const c = b - bc; return { text: `${a} ÷ (${b} − ${c}) = ?`, answer: a / (b - c) }; },
              () => { const a = randomInt(0, 90); const b = randomInt(1, 9); const c = randomInt(1, 9); return { text: `${a} + (${b} × ${c}) = ?`, answer: a + b * c }; },
              () => { const b = randomInt(1, 9); const c = randomInt(1, 9); const a = randomInt(b * c, 99); return { text: `${a} − (${b} × ${c}) = ?`, answer: a - b * c }; },
              () => { const c = randomInt(2, 9); const b = c * randomInt(2, 9); if (b > 81) return null; const a = randomInt(0, 100 - b / c); return { text: `${a} + (${b} ÷ ${c}) = ?`, answer: a + b / c }; },
              () => { const c = randomInt(2, 9); const b = c * randomInt(2, 9); if (b > 81) return null; const a = randomInt(b / c, 99); return { text: `${a} − (${b} ÷ ${c}) = ?`, answer: a - b / c }; }
            ];
            for (let i = 0; i < 20; i++) {
              const t = templates[randomInt(0, templates.length - 1)];
              const r = t();
              if (r && Number.isInteger(r.answer) && r.answer >= 0) return { a: 0, b: 0, op: "+", text: r.text, answer: r.answer, baseLevelId: this.id };
            }
            return { a: 1, b: 1, op: "+", text: "(1 + 1) × 1 = ?", answer: 2, baseLevelId: this.id };
          }
        }
      ]
    };

    // ========= 生存挑战模式：全局状态 =========
    const SURVIVAL_INITIAL_SEC = 60;
    const SURVIVAL_CORRECT_PER_LEVEL = 5;
    const LEVEL_CHALLENGE_CORRECT_PER_LEVEL = 10;
    const TRAINING_QUESTIONS = 30;

    let gameMode = "survival";
    let currentLevelIndex = 0;
    let currentQuestion = null;
    let survivalTimeLeft = 0;
    let survivalTimerId = null;
    let runScore = 0;
    let consecutiveCorrect = 0;
    let gameStartTime = 0;
    let gameOver = false;
    let isPlaying = false;
    let maxLevelThisRun = 0;
    let runWrongCount = 0;

    let wrongPracticeQueue = [];
    let wrongPracticeIndex = 0;
    let wrongPracticeResults = [];
    let trainingQuestionIndex = 0;

    // ========= DOM引用 =========
    const dom = {};

    function initDomRefs() {
      dom.homeSection = document.getElementById("home-section");
      dom.gameSection = document.getElementById("game-section");
      dom.backHomeBtn = document.getElementById("back-home-btn");
      dom.currentLevelName = document.getElementById("current-level-name");
      dom.survivalTime = document.getElementById("survival-time");
      dom.consecutiveCorrect = document.getElementById("consecutive-correct");
      dom.runScore = document.getElementById("run-score");
      dom.bestSurvivalTime = document.getElementById("best-survival-time");
      dom.bestScore = document.getElementById("best-score");

      dom.timerChip = document.getElementById("timer-chip");
      dom.timerValue = document.getElementById("timer-value");
      dom.questionText = document.getElementById("question-text");
      dom.questionSubtext = document.getElementById("question-subtext");
      dom.answerForm = document.getElementById("answer-form");
      dom.answerInput = document.getElementById("answer-input");
      dom.submitBtn = document.getElementById("submit-btn");
      dom.startGameBtn = document.getElementById("start-game-btn");
      dom.feedback = document.getElementById("feedback");
      dom.batchSummary = document.getElementById("batch-summary");
      dom.gameOverPanel = document.getElementById("game-over-panel");
      dom.playAgainBtn = document.getElementById("play-again-btn");
      dom.currentUsernameLabel = document.getElementById("current-username-label");
      dom.recentHistoryBody = document.getElementById("recent-history-body");
      dom.recentHistoryEmpty = document.getElementById("recent-history-empty");
      dom.wrongbookSection = document.getElementById("wrongbook-section");
      dom.wrongbookList = document.getElementById("wrongbook-list");
      dom.wrongbookEmpty = document.getElementById("wrongbook-empty");
      dom.wrongbookPracticeBtn = document.getElementById("wrongbook-practice-btn");
      dom.wrongbookBackBtn = document.getElementById("wrongbook-back-btn");
    }

    // ===== 工具函数 =====
    function randomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function clamp(value, min, max) {
      return Math.max(min, Math.min(max, value));
    }

    function formatSeconds(sec) {
      sec = Math.max(0, Math.round(sec));
      if (sec < 60) return sec + "s";
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return s === 0 ? m + "min" : m + "min " + s + "s";
    }

    function formatDateTime(ts) {
      const d = new Date(ts);
      if (Number.isNaN(d.getTime())) return "-";
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      return `${y}-${m}-${day} ${hh}:${mm}`;
    }

    // ===== 学员账户与 localStorage 状态读写 =====
    const USER_ACCOUNTS_KEY = "adaptive_math_users_v1";
    const CURRENT_USER_KEY = "adaptive_math_current_user_v1";
    const GUEST_STORAGE_KEY = "adaptive_math_survival_guest_v1";
    const GUEST_PLAY_LIMIT = 3;

    let currentUsername = null;
    let isGuestMode = false;
    let cachedUser = null;

    function getApiBase() {
      return (typeof window !== "undefined" && window.API_BASE_URL) || "";
    }

    async function apiLogin(username, password) {
      const base = getApiBase();
      if (!base) return null;
      const res = await fetch(base + "/api/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      });
      const data = await res.json();
      return data;
    }

    async function apiGetUser(username) {
      const base = getApiBase();
      if (!base) return null;
      const res = await fetch(base + "/api/user/" + encodeURIComponent(username));
      const data = await res.json();
      return data.ok ? data.user : null;
    }

    async function apiPutUser(username, updates) {
      const base = getApiBase();
      if (!base) return null;
      const res = await fetch(base + "/api/user/" + encodeURIComponent(username), {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updates)
      });
      const data = await res.json();
      return data.ok ? data.user : null;
    }

    async function apiAppendRun(username, runEntry) {
      const base = getApiBase();
      if (!base) return;
      try {
        await fetch(base + "/api/user/" + encodeURIComponent(username) + "/runs", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(runEntry)
        });
        const u = cachedUser || {};
        const mode = runEntry.mode === "level" ? "level" : (runEntry.mode === "training" ? "training" : "survival");
        u.totalScore = (u.totalScore || 0) + (runEntry.score || 0);
        if (mode === "level") {
          if (!Array.isArray(u.recentLevelRuns)) u.recentLevelRuns = [];
          u.recentLevelRuns.unshift(runEntry);
          if (u.recentLevelRuns.length > 10) u.recentLevelRuns = u.recentLevelRuns.slice(0, 10);
        } else if (mode === "training") {
          if (!Array.isArray(u.recentTrainingRuns)) u.recentTrainingRuns = [];
          u.recentTrainingRuns.unshift(runEntry);
          if (u.recentTrainingRuns.length > 10) u.recentTrainingRuns = u.recentTrainingRuns.slice(0, 10);
        } else {
          if (!Array.isArray(u.recentSurvivalRuns)) u.recentSurvivalRuns = [];
          u.recentSurvivalRuns.unshift(runEntry);
          if (u.recentSurvivalRuns.length > 10) u.recentSurvivalRuns = u.recentSurvivalRuns.slice(0, 10);
          if ((runEntry.survivalTimeSec || 0) > (u.bestSurvivalSec || 0)) u.bestSurvivalSec = runEntry.survivalTimeSec;
          if ((runEntry.score || 0) > (u.bestScore || 0)) u.bestScore = runEntry.score;
        }
        cachedUser = u;
        const updates = mode === "level"
          ? { recentLevelRuns: u.recentLevelRuns, totalScore: u.totalScore }
          : mode === "training"
          ? { recentTrainingRuns: u.recentTrainingRuns, totalScore: u.totalScore }
          : { bestSurvivalSec: u.bestSurvivalSec, bestScore: u.bestScore, totalScore: u.totalScore, recentSurvivalRuns: u.recentSurvivalRuns };
        const updated = await apiPutUser(username, updates);
        if (updated) cachedUser = updated;
      } catch (e) {
        console.warn("同步记录到服务器失败", e);
      }
      renderRecentRuns();
    }

    function loadUsers() {
      try {
        const raw = localStorage.getItem(USER_ACCOUNTS_KEY);
        if (!raw) return [];
        const data = JSON.parse(raw);
        if (data && Array.isArray(data.users)) return data.users;
        return [];
      } catch (e) {
        return [];
      }
    }

    function saveUsers(users) {
      try {
        localStorage.setItem(USER_ACCOUNTS_KEY, JSON.stringify({ users }));
      } catch (e) {
        console.warn("写入学员账户失败。", e);
      }
    }

    function setCurrentUsername(name) {
      currentUsername = name;
      try {
        if (name) {
          localStorage.setItem(CURRENT_USER_KEY, name);
        } else {
          localStorage.removeItem(CURRENT_USER_KEY);
        }
      } catch (e) {
        // ignore
      }
    }

    function loadCurrentUsername() {
      if (currentUsername) return currentUsername;
      try {
        const name = localStorage.getItem(CURRENT_USER_KEY);
        currentUsername = name || null;
      } catch (e) {
        currentUsername = null;
      }
      return currentUsername;
    }

    function getCurrentUser() {
      if (isGuestMode) return null;
      if (cachedUser) return cachedUser;
      const name = loadCurrentUsername();
      if (!name) return null;
      const users = loadUsers();
      return users.find(u => u.username === name) || null;
    }

    function getGuestSurvivalData() {
      try {
        const raw = localStorage.getItem(GUEST_STORAGE_KEY);
        if (!raw)         return { bestSurvivalSec: 0, bestScore: 0, recentSurvivalRuns: [], recentLevelRuns: [], guestPlayCount: 0, levelChallengeLastLevel: 0 };
        const data = JSON.parse(raw);
        return {
          bestSurvivalSec: typeof data.bestSurvivalSec === "number" ? data.bestSurvivalSec : 0,
          bestScore: typeof data.bestScore === "number" ? data.bestScore : 0,
          recentSurvivalRuns: Array.isArray(data.recentSurvivalRuns) ? data.recentSurvivalRuns : [],
          recentLevelRuns: Array.isArray(data.recentLevelRuns) ? data.recentLevelRuns : [],
          guestPlayCount: typeof data.guestPlayCount === "number" ? data.guestPlayCount : 0,
          levelChallengeLastLevel: typeof data.levelChallengeLastLevel === "number" ? data.levelChallengeLastLevel : 0
        };
      } catch (e) {
        return { bestSurvivalSec: 0, bestScore: 0, recentSurvivalRuns: [], recentLevelRuns: [], guestPlayCount: 0, levelChallengeLastLevel: 0 };
      }
    }

    function saveGuestLevelChallengeLastLevel(lastLevel) {
      const data = getGuestSurvivalData();
      data.levelChallengeLastLevel = lastLevel;
      try {
        localStorage.setItem(GUEST_STORAGE_KEY, JSON.stringify(data));
      } catch (e) {
        console.warn("写入游客闯关进度失败。", e);
      }
    }

    function saveGuestSurvivalRun(survivalTimeSec, score, maxLevel, wrongCount) {
      const data = getGuestSurvivalData();
      data.guestPlayCount = (data.guestPlayCount || 0) + 1;
      data.recentSurvivalRuns.unshift({
        survivalTimeSec,
        score,
        maxLevel,
        wrongCount: wrongCount ?? 0,
        ts: Date.now()
      });
      if (data.recentSurvivalRuns.length > 10) {
        data.recentSurvivalRuns = data.recentSurvivalRuns.slice(0, 10);
      }
      if (survivalTimeSec > data.bestSurvivalSec) data.bestSurvivalSec = survivalTimeSec;
      if (score > data.bestScore) data.bestScore = score;
      try {
        localStorage.setItem(GUEST_STORAGE_KEY, JSON.stringify(data));
      } catch (e) {
        console.warn("写入游客记录失败。", e);
      }
    }

    function saveGuestLevelRun(survivalTimeSec, score, maxLevel, wrongCount) {
      const data = getGuestSurvivalData();
      data.guestPlayCount = (data.guestPlayCount || 0) + 1;
      if (!Array.isArray(data.recentLevelRuns)) data.recentLevelRuns = [];
      data.recentLevelRuns.unshift({
        survivalTimeSec,
        score,
        maxLevel,
        wrongCount: wrongCount ?? 0,
        ts: Date.now()
      });
      if (data.recentLevelRuns.length > 10) {
        data.recentLevelRuns = data.recentLevelRuns.slice(0, 10);
      }
      try {
        localStorage.setItem(GUEST_STORAGE_KEY, JSON.stringify(data));
      } catch (e) {
        console.warn("写入游客闯关记录失败。", e);
      }
    }

    function ensureUserProgressDefault(user) {
      if (!user) return;
      if (typeof user.levelIndex !== "number") user.levelIndex = 0;
      if (typeof user.bestLevelIndex !== "number") user.bestLevelIndex = user.levelIndex;
      if (typeof user.totalScore !== "number") user.totalScore = 0;
      if (!Array.isArray(user.history)) user.history = [];
      if (typeof user.bestSurvivalSec !== "number") user.bestSurvivalSec = 0;
      if (typeof user.bestScore !== "number") user.bestScore = 0;
      if (!Array.isArray(user.recentSurvivalRuns)) user.recentSurvivalRuns = [];
      if (!Array.isArray(user.recentLevelRuns)) user.recentLevelRuns = [];
      if (!Array.isArray(user.recentTrainingRuns)) user.recentTrainingRuns = [];
      if (typeof user.levelChallengeLastLevel !== "number") user.levelChallengeLastLevel = 0;
      if (typeof user.levelTrainingCurrentLevel !== "number") user.levelTrainingCurrentLevel = -1;
      if (!Array.isArray(user.wrongAnswers)) user.wrongAnswers = [];
    }

    function loadState() {
      const user = getCurrentUser();
      if (!user) return;
      ensureUserProgressDefault(user);
    }

    function formatSurvivalTime(sec) {
      sec = Math.max(0, Math.round(sec));
      if (sec < 60) return sec + " 秒";
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return s === 0 ? m + " 分" : m + " 分 " + s + " 秒";
    }

    function appendRun(survivalTimeSec, score, maxLevel, wrongCount, mode) {
      wrongCount = wrongCount ?? 0;
      mode = mode === "level" ? "level" : (mode === "training" ? "training" : "survival");
      const runEntry = { survivalTimeSec, score, maxLevel, wrongCount, ts: Date.now(), mode };
      if (isGuestMode) {
        if (mode === "level") saveGuestLevelRun(survivalTimeSec, score, maxLevel, wrongCount);
        else if (mode === "training") { /* 游客暂不支持训练模式记录 */ }
        else saveGuestSurvivalRun(survivalTimeSec, score, maxLevel, wrongCount);
        return;
      }
      const name = loadCurrentUsername();
      if (!name) return;
      if (getApiBase()) {
        apiAppendRun(name, runEntry);
        return;
      }
      const users = loadUsers();
      const idx = users.findIndex(u => u.username === name);
      if (idx === -1) return;
      ensureUserProgressDefault(users[idx]);
      const u = users[idx];
      u.totalScore = (u.totalScore || 0) + score;
      if (mode === "level") {
        if (!Array.isArray(u.recentLevelRuns)) u.recentLevelRuns = [];
        u.recentLevelRuns.unshift(runEntry);
        if (u.recentLevelRuns.length > 10) u.recentLevelRuns = u.recentLevelRuns.slice(0, 10);
      } else if (mode === "training") {
        if (!Array.isArray(u.recentTrainingRuns)) u.recentTrainingRuns = [];
        u.recentTrainingRuns.unshift(runEntry);
        if (u.recentTrainingRuns.length > 10) u.recentTrainingRuns = u.recentTrainingRuns.slice(0, 10);
      } else {
        if (!Array.isArray(u.recentSurvivalRuns)) u.recentSurvivalRuns = [];
        u.recentSurvivalRuns.unshift(runEntry);
        if (u.recentSurvivalRuns.length > 10) u.recentSurvivalRuns = u.recentSurvivalRuns.slice(0, 10);
        if (survivalTimeSec > (u.bestSurvivalSec || 0)) u.bestSurvivalSec = survivalTimeSec;
        if (score > (u.bestScore || 0)) u.bestScore = score;
      }
      if (cachedUser && cachedUser.username === name) cachedUser.totalScore = u.totalScore;
      saveUsers(users);
    }

    function recordWrongAnswer(text, answer, studentAnswer) {
      if (isGuestMode || gameMode === "wrong") return;
      const name = loadCurrentUsername();
      if (!name) return;
      const entry = { text: String(text || ""), answer: Number(answer), studentAnswer: Number(studentAnswer) };
      if (getApiBase()) {
        apiAppendWrongAnswer(name, entry);
        return;
      }
      const users = loadUsers();
      const idx = users.findIndex(u => u.username === name);
      if (idx === -1) return;
      ensureUserProgressDefault(users[idx]);
      const u = users[idx];
      if (!Array.isArray(u.wrongAnswers)) u.wrongAnswers = [];
      u.wrongAnswers.unshift(entry);
      if (u.wrongAnswers.length > 20) u.wrongAnswers = u.wrongAnswers.slice(0, 20);
      saveUsers(users);
    }

    async function apiAppendWrongAnswer(username, entry) {
      const base = getApiBase();
      if (!base) return;
      try {
        const u = cachedUser || {};
        if (!Array.isArray(u.wrongAnswers)) u.wrongAnswers = [];
        u.wrongAnswers.unshift(entry);
        if (u.wrongAnswers.length > 20) u.wrongAnswers = u.wrongAnswers.slice(0, 20);
        cachedUser = u;
        await apiPutUser(username, { wrongAnswers: u.wrongAnswers });
      } catch (e) {
        console.warn("同步错题到服务器失败", e);
      }
    }

    function renderRecentRuns() {
      if (!dom.recentHistoryBody || !dom.recentHistoryEmpty) return;
      const runs = isGuestMode
        ? (gameMode === "level" ? getGuestSurvivalData().recentLevelRuns : gameMode === "training" ? [] : getGuestSurvivalData().recentSurvivalRuns)
        : (() => {
            const user = getCurrentUser();
            if (!user) return [];
            ensureUserProgressDefault(user);
            if (gameMode === "level") return Array.isArray(user.recentLevelRuns) ? user.recentLevelRuns : [];
            if (gameMode === "training") return Array.isArray(user.recentTrainingRuns) ? user.recentTrainingRuns : [];
            return Array.isArray(user.recentSurvivalRuns) ? user.recentSurvivalRuns : [];
          })();
      const titleEl = document.getElementById("recent-title");
      if (titleEl) titleEl.textContent = gameMode === "level" ? "最近十次闯关挑战" : (gameMode === "training" ? "最近十次训练模式" : "最近十次生存挑战");
      if (runs.length === 0) {
        dom.recentHistoryBody.innerHTML = "";
        dom.recentHistoryEmpty.style.display = "block";
        return;
      }
      dom.recentHistoryEmpty.style.display = "none";
      const rows = runs.slice(0, 10).map(r => {
        const timeStr = formatSurvivalTime(r.survivalTimeSec || 0);
        const wrongStr = (r.wrongCount != null ? r.wrongCount : "-").toString();
        const levelName = DIFFICULTY_MODULE.levels[r.maxLevel] ? DIFFICULTY_MODULE.levels[r.maxLevel].id : "-";
        const dateStr = formatDateTime(r.ts);
        return `<tr>
          <td>${timeStr}</td>
          <td>${r.score || 0}</td>
          <td>${wrongStr}</td>
          <td>${levelName}</td>
          <td>${dateStr}</td>
        </tr>`;
      });
      dom.recentHistoryBody.innerHTML = rows.join("");
    }

    // ===== 题目生成与队列逻辑 =====
    function generateBaseQuestion() {
      const level = DIFFICULTY_MODULE.levels[currentLevelIndex];
      return level.generateQuestion();
    }

    // ===== 生存模式：计时与 UI 更新 =====
    function updateSurvivalStatusUI() {
      const label2 = document.getElementById("status-label-2");
      const label3 = document.getElementById("status-label-3");
      const label4 = document.getElementById("status-label-4");
      const label5 = document.getElementById("status-label-5");
      if (label2) label2.textContent = "连续答对";
      if (label3) label3.textContent = "本局得分";
      if (label4) label4.textContent = "个人最佳时间";
      if (label5) label5.textContent = "个人最高得分";
      const m = Math.floor(survivalTimeLeft / 60);
      const s = survivalTimeLeft % 60;
      const timeStr = m + ":" + String(s).padStart(2, "0");
      if (dom.timerChip && dom.timerChip.firstChild) dom.timerChip.firstChild.textContent = "剩余 ";
      if (dom.survivalTime) dom.survivalTime.textContent = timeStr;
      if (dom.timerValue) dom.timerValue.textContent = timeStr;
      if (dom.timerChip) {
        dom.timerChip.classList.toggle("low", survivalTimeLeft <= 10);
      }
      const level = DIFFICULTY_MODULE.levels[currentLevelIndex];
      if (dom.currentLevelName) dom.currentLevelName.textContent = level ? level.name : "-";
      const correctPerLevel = gameMode === "level" ? LEVEL_CHALLENGE_CORRECT_PER_LEVEL : SURVIVAL_CORRECT_PER_LEVEL;
      if (dom.consecutiveCorrect) dom.consecutiveCorrect.textContent = consecutiveCorrect + " / " + correctPerLevel;
      if (dom.runScore) dom.runScore.textContent = runScore;
      if (isGuestMode) {
        const guest = getGuestSurvivalData();
        if (dom.bestSurvivalTime) {
          dom.bestSurvivalTime.textContent = guest.bestSurvivalSec ? formatSurvivalTime(guest.bestSurvivalSec) : "-";
        }
        if (dom.bestScore) dom.bestScore.textContent = (guest.bestScore != null && guest.bestScore > 0) ? guest.bestScore : "-";
        if (dom.currentUsernameLabel) dom.currentUsernameLabel.textContent = "游客";
      } else {
        const user = getCurrentUser();
        if (user) {
          ensureUserProgressDefault(user);
          if (dom.bestSurvivalTime) {
            dom.bestSurvivalTime.textContent = user.bestSurvivalSec ? formatSurvivalTime(user.bestSurvivalSec) : "-";
          }
          if (dom.bestScore) dom.bestScore.textContent = (user.bestScore != null && user.bestScore > 0) ? user.bestScore : "-";
        }
        if (dom.currentUsernameLabel) dom.currentUsernameLabel.textContent = loadCurrentUsername() || "-";
      }
    }

    function setFeedback(message, type) {
      dom.feedback.textContent = "";
      dom.feedback.classList.remove("correct", "incorrect");
      if (!message) return;
      dom.feedback.innerHTML = message;
      if (type === "correct") dom.feedback.classList.add("correct");
      if (type === "incorrect") dom.feedback.classList.add("incorrect");
    }

    function setBatchSummary(text) {
      if (dom.batchSummary) dom.batchSummary.innerHTML = text || "";
    }

    function renderQuestion(question) {
      if (!question) return;
      dom.questionText.textContent = question.text;
      dom.questionSubtext.textContent = "";
      dom.answerInput.value = "";
      setFeedback("", null);
      // 保持输入框焦点，避免手机软键盘收起、画面反复缩放
      dom.answerInput.focus();
      setTimeout(function () {
        dom.answerInput.focus();
      }, 50);
    }

    function startSurvivalGame() {
      if (isGuestMode) {
        const guest = getGuestSurvivalData();
        if ((guest.guestPlayCount || 0) >= GUEST_PLAY_LIMIT) {
          setBatchSummary("试用只限三次，继续使用请联系管理员添加账号。");
          return;
        }
      }
      if (survivalTimerId) clearInterval(survivalTimerId);
      currentLevelIndex = 0;
      survivalTimeLeft = SURVIVAL_INITIAL_SEC;
      runScore = 0;
      consecutiveCorrect = 0;
      runWrongCount = 0;
      gameStartTime = Date.now();
      gameOver = false;
      isPlaying = true;
      maxLevelThisRun = 0;
      if (dom.gameOverPanel) dom.gameOverPanel.style.display = "none";
      if (dom.startGameBtn) dom.startGameBtn.style.display = "none";
      const gameBackRow = document.getElementById("game-back-row");
      if (gameBackRow) gameBackRow.classList.add("hidden");
      if (dom.submitBtn) {
        dom.submitBtn.style.display = "";
        dom.submitBtn.disabled = false;
      }
      const inputRow = document.getElementById("answer-input-row");
      if (inputRow) inputRow.style.display = "";
      dom.answerInput.disabled = false;
      setBatchSummary("");
      updateSurvivalStatusUI();
      survivalTimerId = setInterval(survivalTick, 1000);
      showNextSurvivalQuestion();
    }

    function startLevelGame() {
      if (isGuestMode) {
        const guest = getGuestSurvivalData();
        if ((guest.guestPlayCount || 0) >= GUEST_PLAY_LIMIT) {
          setBatchSummary("试用只限三次，继续使用请联系管理员添加账号。");
          return;
        }
      }
      if (survivalTimerId) clearInterval(survivalTimerId);
      const lastLevel = getLevelChallengeLastLevel();
      currentLevelIndex = lastLevel > 0 ? Math.min(lastLevel - 1, 15) : 0;
      survivalTimeLeft = SURVIVAL_INITIAL_SEC;
      runScore = 0;
      consecutiveCorrect = 0;
      runWrongCount = 0;
      gameStartTime = Date.now();
      gameOver = false;
      isPlaying = true;
      maxLevelThisRun = currentLevelIndex;
      if (dom.gameOverPanel) dom.gameOverPanel.style.display = "none";
      if (dom.startGameBtn) dom.startGameBtn.style.display = "none";
      const gameBackRow = document.getElementById("game-back-row");
      if (gameBackRow) gameBackRow.classList.add("hidden");
      if (dom.submitBtn) {
        dom.submitBtn.style.display = "";
        dom.submitBtn.disabled = false;
      }
      const inputRow = document.getElementById("answer-input-row");
      if (inputRow) inputRow.style.display = "";
      dom.answerInput.disabled = false;
      setBatchSummary("");
      updateSurvivalStatusUI();
      survivalTimerId = setInterval(survivalTick, 1000);
      showNextSurvivalQuestion();
    }

    function survivalTick() {
      if (!isPlaying || gameOver) return;
      survivalTimeLeft -= 1;
      updateSurvivalStatusUI();
      if (survivalTimeLeft <= 0) {
        clearInterval(survivalTimerId);
        survivalTimerId = null;
        if (gameMode === "level") endLevelGame(false);
        else endSurvivalGame();
      }
    }

    function trainingTick() {
      if (!isPlaying || gameOver) return;
      updateTrainingStatusUI();
    }

    function updateTrainingStatusUI() {
      const elapsed = gameStartTime ? Math.round((Date.now() - gameStartTime) / 1000) : 0;
      const m = Math.floor(elapsed / 60);
      const s = elapsed % 60;
      const timeStr = m + ":" + String(s).padStart(2, "0");
      if (dom.timerChip && dom.timerChip.firstChild) dom.timerChip.firstChild.textContent = "用时 ";
      if (dom.timerValue) dom.timerValue.textContent = timeStr;
      if (dom.timerChip) dom.timerChip.classList.remove("low");
      const level = DIFFICULTY_MODULE.levels[currentLevelIndex];
      if (dom.currentLevelName) dom.currentLevelName.textContent = level ? level.name : "-";
      const cfg = getLevelSetting(currentLevelIndex);
      const limit = (cfg && cfg.upgradeTimeLimit) || 300;
      const upgradeAcc = (cfg && typeof cfg.upgradeAccuracy === "number") ? cfg.upgradeAccuracy : 0.95;
      const passAcc = (cfg && typeof cfg.passAccuracy === "number") ? cfg.passAccuracy : 0.8;
      const label2 = document.getElementById("status-label-2");
      const label3 = document.getElementById("status-label-3");
      const label4 = document.getElementById("status-label-4");
      const label5 = document.getElementById("status-label-5");
      if (label2) label2.textContent = "正确率";
      if (label3) label3.textContent = "限时";
      if (label4) label4.textContent = "通关准确率";
      if (label5) label5.textContent = "及格准确率";
      if (dom.consecutiveCorrect) dom.consecutiveCorrect.textContent = runScore + " / " + trainingQuestionIndex;
      if (dom.runScore) dom.runScore.textContent = limit + " 秒";
      if (dom.bestSurvivalTime) dom.bestSurvivalTime.textContent = Math.round(upgradeAcc * 100) + "%";
      if (dom.bestScore) dom.bestScore.textContent = Math.round(passAcc * 100) + "%";
    }

    function startTrainingGame() {
      if (survivalTimerId) clearInterval(survivalTimerId);
      const saved = getLevelTrainingCurrentLevel();
      currentLevelIndex = saved >= 0 ? Math.min(saved, 15) : getTrainingStartLevel();
      trainingQuestionIndex = 0;
      runScore = 0;
      runWrongCount = 0;
      gameStartTime = Date.now();
      gameOver = false;
      isPlaying = true;
      if (dom.gameOverPanel) dom.gameOverPanel.style.display = "none";
      if (dom.startGameBtn) dom.startGameBtn.style.display = "none";
      const gameBackRow = document.getElementById("game-back-row");
      if (gameBackRow) gameBackRow.classList.add("hidden");
      if (dom.submitBtn) {
        dom.submitBtn.style.display = "";
        dom.submitBtn.disabled = false;
      }
      const inputRow = document.getElementById("answer-input-row");
      if (inputRow) inputRow.style.display = "";
      dom.answerInput.disabled = false;
      setBatchSummary("");
      updateTrainingStatusUI();
      survivalTimerId = setInterval(trainingTick, 1000);
      currentQuestion = generateBaseQuestion();
      renderQuestion(currentQuestion);
      if (dom.questionSubtext) dom.questionSubtext.textContent = "第 " + (trainingQuestionIndex + 1) + " 题 / " + TRAINING_QUESTIONS;
    }

    function showNextSurvivalQuestion() {
      if (!isPlaying || gameOver) return;
      currentQuestion = generateBaseQuestion();
      renderQuestion(currentQuestion);
      dom.answerInput.value = "";
      if (dom.submitBtn) dom.submitBtn.disabled = false;
    }

    function endSurvivalGame(completed) {
      if (survivalTimerId) {
        clearInterval(survivalTimerId);
        survivalTimerId = null;
      }
      isPlaying = false;
      gameOver = true;
      if (dom.submitBtn) dom.submitBtn.disabled = true;
      dom.answerInput.disabled = true;
      const survivalTimeSec = Math.round((Date.now() - gameStartTime) / 1000);
      appendRun(survivalTimeSec, runScore, maxLevelThisRun, runWrongCount, "survival");
      renderRecentRuns();
      if (dom.gameOverPanel) {
        dom.gameOverPanel.style.display = "block";
        const titleEl = document.getElementById("game-over-title");
        if (titleEl) titleEl.textContent = completed ? "恭喜通关" : "Game Over";
        const durationEl = document.getElementById("game-over-duration");
        const scoreEl = document.getElementById("game-over-score");
        const maxLevelEl = document.getElementById("game-over-max-level");
        const bestTimeEl = document.getElementById("game-over-best-time");
        const bestScoreEl = document.getElementById("game-over-best-score");
        if (durationEl) durationEl.textContent = formatSurvivalTime(survivalTimeSec);
        if (scoreEl) scoreEl.textContent = runScore;
        const wrongEl = document.getElementById("game-over-wrong");
        if (wrongEl) wrongEl.textContent = runWrongCount;
        const level = DIFFICULTY_MODULE.levels[maxLevelThisRun];
        if (maxLevelEl) maxLevelEl.textContent = level ? level.name : "-";
        if (isGuestMode) {
          const guest = getGuestSurvivalData();
          if (bestTimeEl) bestTimeEl.textContent = guest.bestSurvivalSec ? formatSurvivalTime(guest.bestSurvivalSec) : "-";
          if (bestScoreEl) bestScoreEl.textContent = (guest.bestScore != null && guest.bestScore > 0) ? guest.bestScore : "-";
        } else {
          const user = getCurrentUser();
          if (user) {
            if (bestTimeEl) bestTimeEl.textContent = user.bestSurvivalSec ? formatSurvivalTime(user.bestSurvivalSec) : "-";
            if (bestScoreEl) bestScoreEl.textContent = (user.bestScore != null && user.bestScore > 0) ? user.bestScore : "-";
          }
        }
      }
      if (dom.startGameBtn) dom.startGameBtn.style.display = "none";
      if (dom.playAgainBtn) dom.playAgainBtn.style.display = "";
      const inputRow = document.getElementById("answer-input-row");
      if (inputRow) inputRow.style.display = "none";
    }

    function handleSubmit() {
      if (gameMode === "wrong") {
        handleWrongPracticeSubmit();
        return;
      }
      if (gameMode === "training") {
        if (!isPlaying || gameOver || !currentQuestion) return;
        if (dom.answerInput) dom.answerInput.focus();
        const value = dom.answerInput.value.trim();
        if (value === "") {
          setFeedback("<span class='feedback-title'>提示：</span>请先输入答案。", null);
          return;
        }
        const userAnswer = Number(value);
        if (!Number.isFinite(userAnswer)) {
          setFeedback("<span class='feedback-title'>提示：</span>请输入有效数字。", null);
          return;
        }
        dom.answerInput.value = "";
        if (dom.submitBtn) dom.submitBtn.disabled = true;
        evaluateAnswerTraining(userAnswer);
        return;
      }
      if (!isPlaying || gameOver || !currentQuestion) return;
      // 提交后尽快把焦点拉回输入框，避免手机软键盘收起
      if (dom.answerInput) dom.answerInput.focus();
      const value = dom.answerInput.value.trim();
      if (value === "") {
        setFeedback("<span class='feedback-title'>提示：</span>请先输入答案。", null);
        dom.answerInput.focus();
        return;
      }
      const userAnswer = Number(value);
      if (!Number.isFinite(userAnswer)) {
        setFeedback("<span class='feedback-title'>提示：</span>请输入有效数字。", null);
        return;
      }
      dom.answerInput.value = "";
      if (dom.submitBtn) dom.submitBtn.disabled = true;
      if (gameMode === "level") evaluateAnswerLevel(userAnswer);
      else evaluateAnswerSurvival(userAnswer);
    }

    function handleWrongPracticeSubmit() {
      if (wrongPracticeIndex >= wrongPracticeQueue.length) return;
      if (dom.answerInput) dom.answerInput.focus();
      const value = dom.answerInput.value.trim();
      if (value === "") {
        setFeedback("<span class='feedback-title'>提示：</span>请先输入答案。", null);
        return;
      }
      const userAnswer = Number(value);
      if (!Number.isFinite(userAnswer)) {
        setFeedback("<span class='feedback-title'>提示：</span>请输入有效数字。", null);
        return;
      }
      dom.answerInput.value = "";
      if (dom.submitBtn) dom.submitBtn.disabled = true;
      evaluateAnswerWrong(userAnswer);
    }

    function startWrongPractice() {
      const wrongs = getWrongAnswers();
      if (wrongs.length < 5) return;
      wrongPracticeQueue = wrongs.slice().sort(() => Math.random() - 0.5);
      wrongPracticeIndex = 0;
      wrongPracticeResults = [];
      gameMode = "wrong";
      if (dom.wrongbookSection) dom.wrongbookSection.style.display = "none";
      if (dom.homeSection) dom.homeSection.classList.add("hidden");
      if (dom.gameSection) dom.gameSection.classList.add("visible");
      if (dom.timerChip) dom.timerChip.style.display = "none";
      const statusGrid = document.getElementById("status-grid");
      if (statusGrid) statusGrid.style.display = "none";
      const subtitle = document.getElementById("game-subtitle");
      if (subtitle) subtitle.style.display = "none";
      if (dom.questionSubtext) dom.questionSubtext.textContent = "错题练习 " + (wrongPracticeIndex + 1) + " / " + wrongPracticeQueue.length;
      currentQuestion = { text: wrongPracticeQueue[0].text, answer: wrongPracticeQueue[0].answer };
      renderQuestion(currentQuestion);
      dom.answerInput.value = "";
      dom.answerInput.disabled = false;
      setFeedback("", null);
      if (dom.submitBtn) dom.submitBtn.style.display = "";
      if (dom.startGameBtn) dom.startGameBtn.style.display = "none";
      const gameBackRow = document.getElementById("game-back-row");
      if (gameBackRow) gameBackRow.classList.add("hidden");
      const inputRow = document.getElementById("answer-input-row");
      if (inputRow) inputRow.style.display = "";
    }

    function evaluateAnswerWrong(userAnswer) {
      const q = wrongPracticeQueue[wrongPracticeIndex];
      const correct = userAnswer === q.answer;
      wrongPracticeResults.push({ text: q.text, answer: q.answer, studentAnswer: userAnswer, correct });
      if (correct) {
        setFeedback("<span class='feedback-title'>答对！</span>", "correct");
      } else {
        setFeedback("<span class='feedback-title'>答错了。</span> 正确答案：<strong>" + q.answer + "</strong>", "incorrect");
      }
      wrongPracticeIndex++;
      if (wrongPracticeIndex >= wrongPracticeQueue.length) {
        setTimeout(showWrongPracticeResult, 800);
        return;
      }
      setTimeout(() => {
        currentQuestion = { text: wrongPracticeQueue[wrongPracticeIndex].text, answer: wrongPracticeQueue[wrongPracticeIndex].answer };
        renderQuestion(currentQuestion);
        if (dom.questionSubtext) dom.questionSubtext.textContent = "错题练习 " + (wrongPracticeIndex + 1) + " / " + wrongPracticeQueue.length;
        dom.answerInput.value = "";
        if (dom.submitBtn) dom.submitBtn.disabled = false;
        setFeedback("", null);
      }, 800);
    }

    function showWrongPracticeResult() {
      const correctCount = wrongPracticeResults.filter(r => r.correct).length;
      const total = wrongPracticeResults.length;
      let html = "<div style='text-align:left;max-height:50vh;overflow:auto;padding:0 4px;'>";
      html += "<p style='font-weight:600;margin-bottom:12px;'>批改结果：答对 " + correctCount + " / " + total + " 题</p>";
      wrongPracticeResults.forEach((r) => {
        const mark = r.correct ? "✓" : "✗";
        const markColor = r.correct ? "#2e7d32" : "#d32f2f";
        html += "<div style='padding:8px 0;border-bottom:1px solid #eee;'>";
        html += "<div><strong>题目：</strong>" + escapeHtml(r.text) + "</div>";
        html += "<div style='margin-top:4px;font-size:0.9em;'>学员答案：<span style='color:" + (r.correct ? "#2e7d32" : "#d32f2f") + "'>" + escapeHtml(String(r.studentAnswer)) + "</span> · 对错：<span style='color:" + markColor + "'>" + mark + "</span> · 正确答案：" + escapeHtml(String(r.answer)) + "</div>";
        html += "</div>";
      });
      html += "</div><button id='wrong-result-ok' style='margin-top:12px;padding:10px 24px;cursor:pointer;border-radius:8px;border:none;background:#1976d2;color:#fff;font-size:1rem;'>确定</button>";
      const overlay = document.createElement("div");
      overlay.id = "wrong-result-overlay";
      overlay.style.cssText = "position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:2000;display:flex;align-items:center;justify-content:center;padding:20px;box-sizing:border-box;";
      const box = document.createElement("div");
      box.style.cssText = "background:#fff;border-radius:14px;padding:20px;max-width:400px;width:100%;max-height:80vh;overflow:auto;";
      box.innerHTML = html;
      overlay.appendChild(box);
      document.body.appendChild(overlay);
      box.querySelector("#wrong-result-ok").onclick = function() {
        document.body.removeChild(overlay);
        gameMode = "survival";
        if (dom.timerChip) dom.timerChip.style.display = "";
        const statusGrid = document.getElementById("status-grid");
        if (statusGrid) statusGrid.style.display = "";
        const subtitle = document.getElementById("game-subtitle");
        if (subtitle) subtitle.style.display = "";
        const inputRow = document.getElementById("answer-input-row");
        if (inputRow) inputRow.style.display = "none";
        showWrongbookView();
      };
    }

    function evaluateAnswerSurvival(userAnswer) {
      const question = currentQuestion;
      if (!question) return;
      const isCorrect = userAnswer === question.answer;

      if (isCorrect) {
        survivalTimeLeft += 2;
        const points = currentLevelIndex + 1;
        runScore += points;
        consecutiveCorrect += 1;
        if (consecutiveCorrect >= SURVIVAL_CORRECT_PER_LEVEL) {
          if (currentLevelIndex < DIFFICULTY_MODULE.levels.length - 1) {
            currentLevelIndex += 1;
            consecutiveCorrect = 0;
          } else {
            maxLevelThisRun = Math.max(maxLevelThisRun, currentLevelIndex);
            setFeedback(
              "<span class='feedback-title'>答对！</span> 恭喜通关全部 16 级！",
              "correct"
            );
            updateSurvivalStatusUI();
            setTimeout(function () { endSurvivalGame(true); }, 600);
            return;
          }
        }
        maxLevelThisRun = Math.max(maxLevelThisRun, currentLevelIndex);
        setFeedback(
          "<span class='feedback-title'>答对！</span> +2 秒，+" + points + " 分",
          "correct"
        );
      } else {
        runWrongCount += 1;
        consecutiveCorrect = 0;
        if (currentLevelIndex > 0) currentLevelIndex -= 1;
        recordWrongAnswer(question.text, question.answer, userAnswer);
        setFeedback(
          "<span class='feedback-title'>答错了。</span> 正确答案：<strong>" + question.answer + "</strong>",
          "incorrect"
        );
      }
      updateSurvivalStatusUI();
      setTimeout(showNextSurvivalQuestion, 600);
    }

    function evaluateAnswerLevel(userAnswer) {
      const question = currentQuestion;
      if (!question) return;
      const isCorrect = userAnswer === question.answer;

      if (isCorrect) {
        survivalTimeLeft += 2;
        const points = currentLevelIndex + 1;
        runScore += points;
        consecutiveCorrect += 1;
        if (consecutiveCorrect >= LEVEL_CHALLENGE_CORRECT_PER_LEVEL) {
          if (currentLevelIndex < DIFFICULTY_MODULE.levels.length - 1) {
            currentLevelIndex += 1;
            consecutiveCorrect = 0;
          } else {
            maxLevelThisRun = 15;
            setFeedback(
              "<span class='feedback-title'>答对！</span> 恭喜通关全部 16 级！",
              "correct"
            );
            updateSurvivalStatusUI();
            setTimeout(function () { endLevelGame(true); }, 600);
            return;
          }
        }
        maxLevelThisRun = Math.max(maxLevelThisRun, currentLevelIndex);
        setFeedback(
          "<span class='feedback-title'>答对！</span> +2 秒，+" + points + " 分",
          "correct"
        );
      } else {
        runWrongCount += 1;
        consecutiveCorrect = 0;
        if (currentLevelIndex > 0) currentLevelIndex -= 1;
        recordWrongAnswer(question.text, question.answer, userAnswer);
        setFeedback(
          "<span class='feedback-title'>答错了。</span> 正确答案：<strong>" + question.answer + "</strong>",
          "incorrect"
        );
      }
      updateSurvivalStatusUI();
      setTimeout(showNextSurvivalQuestion, 600);
    }

    function evaluateAnswerTraining(userAnswer) {
      const question = currentQuestion;
      if (!question) return;
      const isCorrect = userAnswer === question.answer;

      if (isCorrect) {
        runScore += 1;
        setFeedback("<span class='feedback-title'>答对！</span> +1 分", "correct");
      } else {
        runWrongCount += 1;
        recordWrongAnswer(question.text, question.answer, userAnswer);
        setFeedback("<span class='feedback-title'>答错了。</span> 正确答案：<strong>" + question.answer + "</strong>", "incorrect");
      }

      trainingQuestionIndex += 1;
      updateTrainingStatusUI();

      if (trainingQuestionIndex >= TRAINING_QUESTIONS) {
        if (dom.submitBtn) dom.submitBtn.disabled = true;
        setTimeout(endTrainingGame, 600);
        return;
      }

      setTimeout(function () {
        currentQuestion = generateBaseQuestion();
        renderQuestion(currentQuestion);
        if (dom.questionSubtext) dom.questionSubtext.textContent = "第 " + (trainingQuestionIndex + 1) + " 题 / " + TRAINING_QUESTIONS;
        if (dom.submitBtn) dom.submitBtn.disabled = false;
      }, 600);
    }

    async function endTrainingGame() {
      if (survivalTimerId) {
        clearInterval(survivalTimerId);
        survivalTimerId = null;
      }
      isPlaying = false;
      gameOver = true;
      if (dom.submitBtn) dom.submitBtn.disabled = true;
      dom.answerInput.disabled = true;

      const survivalTimeSec = Math.round((Date.now() - gameStartTime) / 1000);
      const correctCount = runScore;
      const accuracy = TRAINING_QUESTIONS > 0 ? correctCount / TRAINING_QUESTIONS : 0;
      const cfg = getLevelSetting(currentLevelIndex);
      const passAccuracy = (cfg && typeof cfg.passAccuracy === "number") ? cfg.passAccuracy : 0.8;
      const upgradeAccuracy = (cfg && typeof cfg.upgradeAccuracy === "number") ? cfg.upgradeAccuracy : 0.95;
      const upgradeTimeLimit = (cfg && cfg.upgradeTimeLimit) || 300;
      const overtime = survivalTimeSec > upgradeTimeLimit;

      let newLevel = currentLevelIndex;
      let tipText = "";
      if (accuracy >= upgradeAccuracy && !overtime) {
        if (currentLevelIndex >= 15) {
          tipText = "恭喜通关";
          newLevel = -1;
        } else {
          newLevel = currentLevelIndex + 1;
          tipText = "Level Up!";
        }
      } else if (accuracy >= passAccuracy) {
        tipText = "继续努力！";
      } else {
        newLevel = Math.max(0, currentLevelIndex - 1);
        tipText = "这个可能对你太难了，我们降低难度试试。";
      }

      await saveLevelTrainingCurrentLevel(newLevel >= 0 ? newLevel : -1);
      appendRun(survivalTimeSec, runScore, currentLevelIndex, runWrongCount, "training");
      renderRecentRuns();

      if (dom.gameOverPanel) {
        dom.gameOverPanel.style.display = "block";
        const titleEl = document.getElementById("game-over-title");
        if (titleEl) titleEl.textContent = tipText;
        const durationEl = document.getElementById("game-over-duration");
        const scoreEl = document.getElementById("game-over-score");
        const wrongEl = document.getElementById("game-over-wrong");
        const maxLevelEl = document.getElementById("game-over-max-level");
        const bestTimeEl = document.getElementById("game-over-best-time");
        const bestScoreEl = document.getElementById("game-over-best-score");
        if (durationEl) durationEl.textContent = formatSurvivalTime(survivalTimeSec) + "（用时）";
        if (scoreEl) scoreEl.textContent = runScore + " / " + TRAINING_QUESTIONS + "（正确 " + correctCount + " 题）";
        if (wrongEl) wrongEl.textContent = runWrongCount;
        const level = DIFFICULTY_MODULE.levels[currentLevelIndex];
        if (maxLevelEl) maxLevelEl.textContent = "准确率 " + Math.round(accuracy * 100) + "%";
        if (bestTimeEl) bestTimeEl.textContent = "-";
        if (bestScoreEl) bestScoreEl.textContent = "-";
      }
      if (dom.startGameBtn) dom.startGameBtn.style.display = "none";
      if (dom.playAgainBtn) dom.playAgainBtn.style.display = "";
      const inputRow = document.getElementById("answer-input-row");
      if (inputRow) inputRow.style.display = "none";
    }

    function endLevelGame(completed) {
      if (survivalTimerId) {
        clearInterval(survivalTimerId);
        survivalTimerId = null;
      }
      isPlaying = false;
      gameOver = true;
      if (dom.submitBtn) dom.submitBtn.disabled = true;
      dom.answerInput.disabled = true;
      const survivalTimeSec = Math.round((Date.now() - gameStartTime) / 1000);
      const endLevel = completed ? 15 : currentLevelIndex;
      saveLevelChallengeLastLevel(endLevel);
      appendRun(survivalTimeSec, runScore, endLevel, runWrongCount, "level");
      renderRecentRuns();
      if (dom.gameOverPanel) {
        dom.gameOverPanel.style.display = "block";
        const titleEl = document.getElementById("game-over-title");
        const levelNum = endLevel + 1;
        if (titleEl) titleEl.textContent = completed ? "恭喜通关" : "恭喜你达到第 " + levelNum + " 级";
        const durationEl = document.getElementById("game-over-duration");
        const scoreEl = document.getElementById("game-over-score");
        const maxLevelEl = document.getElementById("game-over-max-level");
        const bestTimeEl = document.getElementById("game-over-best-time");
        const bestScoreEl = document.getElementById("game-over-best-score");
        if (durationEl) durationEl.textContent = formatSurvivalTime(survivalTimeSec);
        if (scoreEl) scoreEl.textContent = runScore;
        const wrongEl = document.getElementById("game-over-wrong");
        if (wrongEl) wrongEl.textContent = runWrongCount;
        const level = DIFFICULTY_MODULE.levels[endLevel];
        if (maxLevelEl) maxLevelEl.textContent = level ? level.name : "-";
        if (isGuestMode) {
          const guest = getGuestSurvivalData();
          if (bestTimeEl) bestTimeEl.textContent = guest.bestSurvivalSec ? formatSurvivalTime(guest.bestSurvivalSec) : "-";
          if (bestScoreEl) bestScoreEl.textContent = (guest.bestScore != null && guest.bestScore > 0) ? guest.bestScore : "-";
        } else {
          const user = getCurrentUser();
          if (user) {
            if (bestTimeEl) bestTimeEl.textContent = user.bestSurvivalSec ? formatSurvivalTime(user.bestSurvivalSec) : "-";
            if (bestScoreEl) bestScoreEl.textContent = (user.bestScore != null && user.bestScore > 0) ? user.bestScore : "-";
          }
        }
      }
      if (dom.startGameBtn) dom.startGameBtn.style.display = "none";
      if (dom.playAgainBtn) dom.playAgainBtn.style.display = "";
      const inputRow = document.getElementById("answer-input-row");
      if (inputRow) inputRow.style.display = "none";
    }

    // ===== 首页与模式切换 =====
    function updateHomeTotalScore() {
      const el = document.getElementById("home-total-score");
      if (!el) return;
      if (isGuestMode) {
        el.style.display = "none";
        return;
      }
      const user = getCurrentUser();
      if (!user) {
        el.style.display = "none";
        return;
      }
      el.style.display = "block";
      const score = (user.totalScore != null && typeof user.totalScore === "number") ? user.totalScore : 0;
      el.innerHTML = "个人总积分：<strong>" + score + "</strong>";
    }

    function exitGameToHome() {
      if (survivalTimerId) {
        clearInterval(survivalTimerId);
        survivalTimerId = null;
      }
      isPlaying = false;
      gameOver = true;
      if (gameMode === "wrong") {
        gameMode = "survival";
        if (dom.timerChip) dom.timerChip.style.display = "";
        const statusGrid = document.getElementById("status-grid");
        if (statusGrid) statusGrid.style.display = "";
        const subtitle = document.getElementById("game-subtitle");
        if (subtitle) subtitle.style.display = "";
      }
      if (dom.gameOverPanel) dom.gameOverPanel.style.display = "none";
      if (dom.submitBtn) dom.submitBtn.style.display = "none";
      if (dom.startGameBtn) dom.startGameBtn.style.display = "";
      if (dom.playAgainBtn) dom.playAgainBtn.style.display = "none";
      showHome();
    }

    function showHome() {
      if (dom.homeSection) dom.homeSection.classList.remove("hidden");
      if (dom.gameSection) dom.gameSection.classList.remove("visible");
      if (dom.wrongbookSection) dom.wrongbookSection.style.display = "none";
      if (dom.gameOverPanel) dom.gameOverPanel.style.display = "none";
      updateHomeTotalScore();
    }

    function showGameSection() {
      if (dom.homeSection) dom.homeSection.classList.add("hidden");
      if (dom.gameSection) dom.gameSection.classList.add("visible");
      if (dom.wrongbookSection) dom.wrongbookSection.style.display = "none";
      if (dom.gameOverPanel) dom.gameOverPanel.style.display = "none";
      if (gameMode === "training") {
        if (dom.timerChip) dom.timerChip.style.display = "";
        const statusGrid = document.getElementById("status-grid");
        if (statusGrid) statusGrid.style.display = "";
        const subtitle = document.getElementById("game-subtitle");
        if (subtitle) subtitle.style.display = "";
        updateTrainingStatusUI();
      } else {
        updateSurvivalStatusUI();
      }
      renderRecentRuns();
      if (dom.submitBtn) dom.submitBtn.style.display = "none";
      if (dom.startGameBtn) dom.startGameBtn.style.display = "";
      const inputRow = document.getElementById("answer-input-row");
      if (inputRow) inputRow.style.display = "none";
      const gameBackRow = document.getElementById("game-back-row");
      if (gameBackRow) gameBackRow.classList.remove("hidden");
    }

    function getWrongAnswers() {
      const user = getCurrentUser();
      if (!user) return [];
      ensureUserProgressDefault(user);
      return Array.isArray(user.wrongAnswers) ? user.wrongAnswers : [];
    }

    async function showWrongbookView() {
      if (dom.homeSection) dom.homeSection.classList.add("hidden");
      if (dom.gameSection) dom.gameSection.classList.remove("visible");
      if (dom.wrongbookSection) dom.wrongbookSection.style.display = "block";
      if (getApiBase()) {
        const name = loadCurrentUsername();
        if (name) {
          try {
            const u = await apiGetUser(name);
            if (u) { cachedUser = u; ensureUserProgressDefault(cachedUser); }
          } catch (e) { console.warn("刷新错题失败", e); }
        }
      }
      renderWrongbookList();
    }

    function renderWrongbookList() {
      const list = dom.wrongbookList;
      const empty = dom.wrongbookEmpty;
      const practiceBtn = dom.wrongbookPracticeBtn;
      if (!list || !empty) return;
      const wrongs = getWrongAnswers();
      if (wrongs.length === 0) {
        list.innerHTML = "";
        empty.style.display = "block";
        if (practiceBtn) practiceBtn.style.display = "none";
        return;
      }
      empty.style.display = "none";
      list.innerHTML = wrongs.map(w => `
        <div class="wrongbook-item">
          <div class="q">${escapeHtml(w.text || "")}</div>
          <div>学员答案：<span class="wrong-ans">${escapeHtml(String(w.studentAnswer ?? ""))}</span> · 正确答案：<span class="correct-ans">${escapeHtml(String(w.answer ?? ""))}</span></div>
        </div>
      `).join("");
      if (practiceBtn) practiceBtn.style.display = wrongs.length >= 5 ? "" : "none";
    }

    function escapeHtml(s) {
      const div = document.createElement("div");
      div.textContent = s;
      return div.innerHTML;
    }

    function handleModeSurvival() {
      gameMode = "survival";
      const sub = document.getElementById("game-subtitle");
      if (sub) sub.textContent = "生存挑战：从 L1 开始，答对加 2 秒并得分（L1=1 分…L16=16 分），连续对 5 题升级、错 1 题降级，看你能撑多久！";
      showGameSection();
    }

    function getLevelChallengeLastLevel() {
      if (isGuestMode) {
        const g = getGuestSurvivalData();
        return g.levelChallengeLastLevel || 0;
      }
      const u = getCurrentUser();
      if (!u) return 0;
      ensureUserProgressDefault(u);
      return u.levelChallengeLastLevel || 0;
    }

    function saveLevelChallengeLastLevel(lastLevel) {
      if (isGuestMode) {
        saveGuestLevelChallengeLastLevel(lastLevel);
        return;
      }
      const name = loadCurrentUsername();
      if (!name) return;
      if (getApiBase()) {
        apiPutUser(name, { levelChallengeLastLevel: lastLevel });
        if (cachedUser) cachedUser.levelChallengeLastLevel = lastLevel;
      } else {
        const users = loadUsers();
        const idx = users.findIndex(u => u.username === name);
        if (idx >= 0) {
          users[idx].levelChallengeLastLevel = lastLevel;
          saveUsers(users);
          if (cachedUser) cachedUser.levelChallengeLastLevel = lastLevel;
        }
      }
    }

    function getTrainingStartLevel() {
      const user = getCurrentUser();
      if (!user) return 0;
      ensureUserProgressDefault(user);
      const survivalMax = (user.recentSurvivalRuns || []).reduce((m, r) => Math.max(m, r.maxLevel ?? 0), 0);
      const levelMax = (user.recentLevelRuns || []).reduce((m, r) => Math.max(m, r.maxLevel ?? 0), 0);
      const n = Math.max(survivalMax, levelMax);
      return n > 0 ? Math.min(n - 1, 15) : 0;
    }

    function getLevelTrainingCurrentLevel() {
      const user = getCurrentUser();
      if (!user) return -1;
      ensureUserProgressDefault(user);
      const v = user.levelTrainingCurrentLevel;
      return typeof v === "number" ? v : -1;
    }

    async function saveLevelTrainingCurrentLevel(level) {
      const name = loadCurrentUsername();
      if (!name) return;
      if (getApiBase()) {
        try {
          const updated = await apiPutUser(name, { levelTrainingCurrentLevel: level });
          if (cachedUser) cachedUser.levelTrainingCurrentLevel = level;
          if (updated) cachedUser = updated;
        } catch (e) {
          if (cachedUser) cachedUser.levelTrainingCurrentLevel = level;
        }
      } else {
        const users = loadUsers();
        const idx = users.findIndex(u => u.username === name);
        if (idx >= 0) {
          users[idx].levelTrainingCurrentLevel = level;
          saveUsers(users);
          if (cachedUser && cachedUser.username === name) cachedUser.levelTrainingCurrentLevel = level;
        }
      }
    }

    function handleModeLevel() {
      if (isGuestMode) {
        alert("游客模式仅支持生存挑战。");
        return;
      }
      const lastLevel = getLevelChallengeLastLevel();
      if (lastLevel >= 15) {
        if (!confirm("您已通关，是否从 L1 开始新游戏？")) return;
        saveLevelChallengeLastLevel(0);
      }
      gameMode = "level";
      const sub = document.getElementById("game-subtitle");
      if (sub) sub.textContent = "闯关挑战：每关 10 题，连续答对升级、错 1 题降级，1 分钟倒计时，答对 +2 秒。";
      showGameSection();
    }

    function handleModePractice() {
      if (isGuestMode) {
        alert("游客模式仅支持生存挑战。");
        return;
      }
      gameMode = "training";
      const sub = document.getElementById("game-subtitle");
      if (sub) sub.textContent = "训练模式：每局 " + TRAINING_QUESTIONS + " 题，正向计时。准确率≥通关且未超时则升级，≥及格则保持，<及格则降级。";
      const tip = "训练模式说明：\n\n• 每局 " + TRAINING_QUESTIONS + " 题，答对计分\n• 正向计时，显示用时\n• 根据准确率与用时决定升降级\n• 起始等级由最近生存/闯关最高等级决定\n\n点击「开始游戏」开始。";
      alert(tip);
      showGameSection();
    }

    function handleModeWrongbook() {
      if (isGuestMode) {
        alert("游客模式仅支持生存挑战。");
        return;
      }
      showWrongbookView();
    }

    // ===== 登录 / 注销 =====
    async function handleLogin() {
      const usernameInput = document.getElementById("login-username");
      const passwordInput = document.getElementById("login-password");
      const errorEl = document.getElementById("login-error");
      const username = (usernameInput.value || "").trim();
      const password = passwordInput.value || "";

      if (!username || !password) {
        errorEl.textContent = "请输入用户名和密码。";
        return;
      }

      if (getApiBase()) {
        const data = await apiLogin(username, password);
        if (!data || !data.ok) {
          errorEl.textContent = data && data.error ? data.error : "登录失败，请检查网络或联系老师。";
          return;
        }
        cachedUser = data.user;
      } else {
        const users = loadUsers();
        const user = users.find(u => u.username === username);
        if (!user) {
          errorEl.textContent = "用户不存在，请联系老师在后台添加。";
          return;
        }
        if (user.password !== password) {
          errorEl.textContent = "密码错误。";
          return;
        }
        cachedUser = user;
      }

      setCurrentUsername(username);
      ensureUserProgressDefault(cachedUser);
      await refreshGameSettings();
      errorEl.textContent = "";
      document.getElementById("login-view").style.display = "none";
      document.getElementById("app-view").style.display = "flex";
      loadState();
      showHome();
    }

    async function handleGuestEnter() {
      const guest = getGuestSurvivalData();
      if ((guest.guestPlayCount || 0) >= GUEST_PLAY_LIMIT) {
        const errorEl = document.getElementById("login-error");
        if (errorEl) errorEl.textContent = "试用只限三次，继续使用请联系管理员添加账号。";
        return;
      }
      isGuestMode = true;
      setCurrentUsername(null);
      await refreshGameSettings();
      document.getElementById("login-view").style.display = "none";
      document.getElementById("app-view").style.display = "flex";
      const errorEl = document.getElementById("login-error");
      if (errorEl) errorEl.textContent = "";
      loadState();
      showHome();
    }

    function handleLogout() {
      isGuestMode = false;
      cachedUser = null;
      setCurrentUsername(null);
      document.getElementById("app-view").style.display = "none";
      document.getElementById("login-view").style.display = "flex";
      const errorEl = document.getElementById("login-error");
      if (errorEl) errorEl.textContent = "";
      const pwd = document.getElementById("login-password");
      if (pwd) pwd.value = "";
    }

    // ===== 事件绑定与初始化 =====
    function bindEvents() {
      if (dom.answerForm) {
        dom.answerForm.addEventListener("submit", function (e) {
          e.preventDefault();
          handleSubmit();
        });
      }
      // 提交后立即把焦点拉回输入框，减少手机软键盘收起、画面缩放
      dom.submitBtn.addEventListener("mousedown", function () {
        if (dom.answerInput && isPlaying && !gameOver) dom.answerInput.focus();
      });
      dom.submitBtn.addEventListener("touchstart", function () {
        if (dom.answerInput && isPlaying && !gameOver) dom.answerInput.focus();
      }, { passive: true });
      if (dom.startGameBtn) dom.startGameBtn.addEventListener("click", function () {
        if (gameMode === "training") startTrainingGame();
        else if (gameMode === "level") startLevelGame();
        else startSurvivalGame();
      });
      if (dom.playAgainBtn) dom.playAgainBtn.addEventListener("click", () => {
        if (dom.playAgainBtn) dom.playAgainBtn.style.display = "none";
        if (gameMode === "training") startTrainingGame();
        else if (gameMode === "level") startLevelGame();
        else startSurvivalGame();
      });
      if (dom.backHomeBtn) dom.backHomeBtn.addEventListener("click", showHome);
      const gameBackHomeBtn = document.getElementById("game-back-home-btn");
      if (gameBackHomeBtn) gameBackHomeBtn.addEventListener("click", exitGameToHome);

      const modeSurvival = document.getElementById("mode-survival");
      const modeLevel = document.getElementById("mode-level");
      const modePractice = document.getElementById("mode-practice");
      const modeWrongbook = document.getElementById("mode-wrongbook");
      if (modeSurvival) modeSurvival.addEventListener("click", handleModeSurvival);
      if (modeLevel) modeLevel.addEventListener("click", handleModeLevel);
      if (modePractice) modePractice.addEventListener("click", handleModePractice);
      if (modeWrongbook) modeWrongbook.addEventListener("click", handleModeWrongbook);
      if (dom.wrongbookBackBtn) dom.wrongbookBackBtn.addEventListener("click", showHome);
      if (dom.wrongbookPracticeBtn) dom.wrongbookPracticeBtn.addEventListener("click", startWrongPractice);

      dom.answerInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          handleSubmit();
        }
      });
      // 键盘「前往/Go」等也会触发表单 submit，无需再绑 click

      const loginBtn = document.getElementById("login-btn");
      loginBtn.addEventListener("click", handleLogin);
      const guestBtn = document.getElementById("guest-btn");
      if (guestBtn) guestBtn.addEventListener("click", handleGuestEnter);
      const loginPassword = document.getElementById("login-password");
      loginPassword.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          handleLogin();
        }
      });

      const logoutBtn = document.getElementById("logout-btn");
      logoutBtn.addEventListener("click", handleLogout);
    }

    async function init() {
      initDomRefs();
      bindEvents();
      const name = loadCurrentUsername();
      if (!name) {
        document.getElementById("login-view").style.display = "flex";
        document.getElementById("app-view").style.display = "none";
        return;
      }
      if (getApiBase()) {
        try {
          const user = await apiGetUser(name);
          if (user) {
            cachedUser = user;
            ensureUserProgressDefault(cachedUser);
            await refreshGameSettings();
            document.getElementById("login-view").style.display = "none";
            document.getElementById("app-view").style.display = "flex";
            loadState();
            updateHomeTotalScore();
            updateSurvivalStatusUI();
            renderRecentRuns();
            if (dom.submitBtn) dom.submitBtn.style.display = "none";
            if (dom.startGameBtn) dom.startGameBtn.style.display = "";
            if (dom.gameOverPanel) dom.gameOverPanel.style.display = "none";
            if (dom.playAgainBtn) dom.playAgainBtn.style.display = "none";
            return;
          }
        } catch (e) {
          console.warn("从服务器加载用户失败，尝试本地", e);
        }
      }
      const user = loadUsers().find(u => u.username === name);
      if (user) {
        cachedUser = user;
        ensureUserProgressDefault(cachedUser);
        await refreshGameSettings();
        document.getElementById("login-view").style.display = "none";
        document.getElementById("app-view").style.display = "flex";
        loadState();
        updateHomeTotalScore();
        updateSurvivalStatusUI();
        renderRecentRuns();
        if (dom.submitBtn) dom.submitBtn.style.display = "none";
        if (dom.startGameBtn) dom.startGameBtn.style.display = "";
        if (dom.gameOverPanel) dom.gameOverPanel.style.display = "none";
        if (dom.playAgainBtn) dom.playAgainBtn.style.display = "none";
      } else {
        document.getElementById("login-view").style.display = "flex";
        document.getElementById("app-view").style.display = "none";
      }
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>

