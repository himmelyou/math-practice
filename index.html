<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Jarvis Math Lab 计算游戏</title>
  <script src="config.js"></script>
  <style>
    :root {
      --bg: #e6f3ff;
      --card-bg: #ffffff;
      --primary: #1976d2;
      --primary-light: #63a4ff;
      --danger: #d32f2f;
      --success: #2e7d32;
      --text-main: #123047;
      --muted: #607d8b;
      --border-radius: 14px;
      --shadow-soft: 0 10px 25px rgba(0, 0, 0, 0.08);
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "PingFang SC", "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: radial-gradient(circle at top left, #f5fbff, var(--bg));
      color: var(--text-main);
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .login-view {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 16px;
    }

    .login-card {
      width: 100%;
      max-width: 380px;
      background: #ffffff;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-soft);
      padding: 18px 18px 16px;
    }

    .login-title {
      margin: 0 0 6px;
      font-size: 1.4rem;
      font-weight: 700;
      color: #0d47a1;
      text-align: left;
    }

    .login-subtitle {
      margin: 0 0 14px;
      font-size: 0.86rem;
      color: var(--muted);
    }

    .login-field {
      margin-bottom: 10px;
    }

    .login-field input {
      width: 100%;
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(13, 71, 161, 0.16);
      outline: none;
      font-size: 0.95rem;
      box-sizing: border-box;
    }

    .login-field input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.16);
      background: #f7fbff;
    }

    .login-btn {
      width: 100%;
      margin-top: 4px;
      border-radius: 999px;
      border: none;
      padding: 9px 14px;
      font-size: 0.96rem;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: #fff;
      box-shadow: 0 6px 14px rgba(25, 118, 210, 0.4);
    }

    .guest-btn {
      margin-top: 8px;
      background: #f1f6ff;
      color: var(--primary);
      box-shadow: none;
      border: 1px solid rgba(25, 118, 210, 0.25);
    }

    .login-error {
      min-height: 18px;
      margin-top: 6px;
      font-size: 0.8rem;
      color: var(--danger);
    }

    .login-hint {
      margin-top: 8px;
      font-size: 0.78rem;
      color: var(--muted);
    }

    .login-version {
      margin-top: 10px;
      margin-bottom: 0;
      font-size: 0.72rem;
      color: var(--muted);
    }

    .app {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 16px;
      max-width: 720px;
      margin: 0 auto;
    }

    .app-header {
      text-align: left;
      padding: 8px 4px 8px;
    }

    .app-title {
      margin: 0 0 6px;
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: 0.04em;
      color: #0d47a1;
    }

    .subtitle {
      margin: 0;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .user-bar {
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 0.82rem;
      color: var(--muted);
    }

    .user-name {
      font-weight: 600;
      color: var(--primary);
    }

    .logout-btn {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 0.8rem;
      cursor: pointer;
      background: #f5f7ff;
      color: #546e7a;
    }

    .status-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px 12px;
      margin-top: 8px;
    }

    .status-item {
      font-size: 0.8rem;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
      min-width: 0;
    }

    .status-label {
      opacity: 0.8;
    }

    .status-value {
      font-weight: 600;
      color: var(--text-main);
    }

    .status-value.highlight {
      color: var(--primary);
    }

    .status-value.danger {
      color: var(--danger);
    }

    .status-value.success {
      color: var(--success);
    }

    .card {
      flex: 1;
      margin-top: 8px;
      padding: 18px 16px 14px;
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .question-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .question-label {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--primary);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: rgba(25, 118, 210, 0.08);
      color: var(--primary);
    }

    .badge.remedial {
      background: rgba(255, 193, 7, 0.18);
      color: #f57f17;
    }

    .timer-chip {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      background: rgba(25, 118, 210, 0.06);
      color: var(--primary);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .timer-chip.low {
      background: rgba(211, 47, 47, 0.08);
      color: var(--danger);
    }

    .question-text {
      margin-top: 4px;
      font-size: 1.25rem;
      font-weight: 600;
      text-align: center;
      padding: 8px 6px 4px;
    }

    .question-subtext {
      font-size: 0.85rem;
      text-align: center;
      color: var(--muted);
    }

    .answer-form {
      margin: 0;
      max-width: 380px;
      margin-left: auto;
      margin-right: auto;
    }

    .input-row {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }

    .input-row input[type="number"] {
      flex: 1;
      padding: 10px 12px;
      font-size: 16px; /* 避免 iOS 聚焦输入框时自动放大页面 */
      border-radius: 999px;
      border: 1px solid rgba(13, 71, 161, 0.16);
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background-color 0.15s ease;
      text-align: center;
    }

    .input-row input[type="number"]:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.16);
      background: #f7fbff;
    }

    .button-row {
      display: flex;
      gap: 10px;
      margin-top: 8px;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 10px 14px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.12s ease, background-color 0.12s ease, opacity 0.12s ease;
      font-family: inherit;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      white-space: nowrap;
    }

    button:active {
      transform: scale(0.97);
    }

    .btn-primary {
      flex: 2;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: #fff;
      box-shadow: 0 6px 14px rgba(25, 118, 210, 0.4);
    }

    #submit-btn {
      padding: 20px 14px;
      min-height: 2.8em;
    }

    .btn-primary:disabled {
      opacity: 0.55;
      box-shadow: none;
      cursor: default;
    }

    .btn-secondary {
      flex: 1.3;
      background: #f1f6ff;
      color: var(--primary);
      border: 1px solid rgba(25, 118, 210, 0.18);
      box-shadow: 0 4px 10px rgba(13, 71, 161, 0.08);
    }

    .btn-secondary:disabled {
      opacity: 0.4;
      box-shadow: none;
      cursor: default;
    }

    .feedback {
      min-height: 40px;
      margin-top: 6px;
      font-size: 0.9rem;
      line-height: 1.5;
      border-radius: 12px;
      padding: 8px 10px;
      background: #f7fbff;
      color: var(--muted);
    }

    .feedback.correct {
      background: #e8f5e9;
      color: var(--success);
    }

    .feedback.incorrect {
      background: #ffebee;
      color: var(--danger);
    }

    .feedback-title {
      font-weight: 600;
      margin-right: 4px;
    }

    .batch-summary {
      margin-top: 6px;
      font-size: 0.85rem;
      color: var(--muted);
      border-top: 1px dashed rgba(96, 125, 139, 0.35);
      padding-top: 6px;
    }

    .batch-summary strong {
      color: var(--text-main);
    }

    .recent-card {
      margin-top: 10px;
      padding: 12px 14px 10px;
      background: #ffffff;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-soft);
      font-size: 0.82rem;
    }

    .recent-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      color: var(--muted);
    }

    .recent-title {
      font-weight: 600;
      color: var(--text-main);
      font-size: 0.86rem;
    }

    .recent-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    .recent-table th,
    .recent-table td {
      padding: 4px 2px;
      text-align: center;
      border-bottom: 1px solid #e3edf7;
      white-space: nowrap;
    }

    .recent-table th {
      font-weight: 600;
      color: var(--muted);
      font-size: 0.78rem;
    }

    .recent-table td:first-child {
      text-align: left;
    }

    .recent-empty {
      margin-top: 4px;
      font-size: 0.78rem;
      color: var(--muted);
    }

    .game-over-panel {
      margin-top: 14px;
      padding: 16px;
      background: #f5f9ff;
      border-radius: var(--border-radius);
      border: 1px solid rgba(25, 118, 210, 0.2);
      text-align: center;
    }

    .game-over-title {
      margin: 0 0 12px;
      font-size: 1.3rem;
      color: var(--primary);
    }

    .game-over-line {
      margin: 6px 0;
      font-size: 0.9rem;
      color: var(--text-main);
    }

    .game-over-best {
      color: var(--muted);
      font-size: 0.85rem;
    }

    .app-footer {
      margin-top: 10px;
      font-size: 0.76rem;
      text-align: center;
      color: var(--muted);
    }

    @media (min-width: 768px) {
      .app {
        padding: 20px 24px;
      }

      .card {
        padding: 20px 24px 18px;
      }

      .app-title {
        font-size: 1.7rem;
      }
    }
  </style>
</head>
<body>
  <div id="login-view" class="login-view">
    <div class="login-card">
      <h1 class="login-title">Jarvis Math Lab 计算游戏</h1>
      <p class="login-subtitle">请先登录学员账号再开始练习（账号由老师在后台创建）。</p>
      <div class="login-field">
        <input id="login-username" type="text" autocomplete="username" placeholder="用户名" />
      </div>
      <div class="login-field">
        <input id="login-password" type="password" autocomplete="current-password" placeholder="密码" />
      </div>
      <button id="login-btn" class="login-btn">登录</button>
      <button id="guest-btn" class="login-btn guest-btn">游客试玩</button>
      <div id="login-error" class="login-error"></div>
      <p class="login-hint">本练习无法自行注册，请联系尤老师获取账号与密码。也可先游客试玩，数据仅保存在本机。登录后记录将同步到服务器。</p>
      <p class="login-version">版本 v1.1.1</p><!-- 与页脚版本号保持一致 -->
    </div>
  </div>

  <div class="app" id="app-view" style="display:none;">
    <header class="app-header">
      <h1 class="app-title">Jarvis Math Lab 计算游戏</h1>
      <p class="subtitle">生存挑战：从 L1 开始，答对加 2 秒并得分（L1=1 分…L16=16 分），连续对 5 题升级、错 1 题降级，看你能撑多久！</p>

      <div class="user-bar">
        <span>当前学员：<span class="user-name" id="current-username-label">-</span></span>
        <button id="logout-btn" class="logout-btn">注销</button>
      </div>

      <div class="status-grid">
        <div class="status-item">
          <span class="status-label">剩余时间</span>
          <span class="status-value highlight" id="survival-time">0:00</span>
        </div>
        <div class="status-item">
          <span class="status-label">当前难度</span>
          <span class="status-value" id="current-level-name">-</span>
        </div>
        <div class="status-item">
          <span class="status-label">连续答对</span>
          <span class="status-value" id="consecutive-correct">0 / 5</span>
        </div>
        <div class="status-item">
          <span class="status-label">本局得分</span>
          <span class="status-value" id="run-score">0</span>
        </div>
        <div class="status-item">
          <span class="status-label">个人最佳时间</span>
          <span class="status-value" id="best-survival-time">-</span>
        </div>
        <div class="status-item">
          <span class="status-label">个人最高得分</span>
          <span class="status-value" id="best-score">-</span>
        </div>
      </div>
    </header>

    <main class="card" id="game-card">
      <div class="question-header">
        <div class="question-label">当前题目</div>
        <div class="timer-chip" id="timer-chip">
          剩余 <span id="timer-value">1:00</span>
        </div>
      </div>

      <div class="question-text" id="question-text">0 + 0 = ?</div>
      <div class="question-subtext" id="question-subtext"></div>

      <form id="answer-form" class="answer-form" action="javascript:void(0);">
        <div class="input-row">
          <input id="answer-input" type="number" inputmode="numeric" pattern="\d*" autocomplete="off" placeholder="在这里输入你的答案" enterkeyhint="go" />
        </div>
        <div class="button-row">
          <button type="submit" class="btn-primary" id="submit-btn">提交答案</button>
          <button type="button" class="btn-primary" id="start-game-btn">开始游戏</button>
        </div>
      </form>

      <div class="feedback" id="feedback"></div>
      <div class="batch-summary" id="batch-summary"></div>

      <div id="game-over-panel" class="game-over-panel" style="display:none;">
        <h2 class="game-over-title" id="game-over-title">Game Over</h2>
        <p class="game-over-line">本局存活：<strong id="game-over-duration">-</strong></p>
        <p class="game-over-line">本局得分：<strong id="game-over-score">0</strong></p>
        <p class="game-over-line">本局错题：<strong id="game-over-wrong">0</strong></p>
        <p class="game-over-line">到达最高难度：<strong id="game-over-max-level">-</strong></p>
        <p class="game-over-line game-over-best">个人最佳：<span id="game-over-best-time">-</span> · 最高得分 <span id="game-over-best-score">-</span></p>
        <button class="btn-primary" id="play-again-btn">再玩一局</button>
      </div>
    </main>

    <section class="recent-card">
      <div class="recent-header">
        <span class="recent-title">最近十次生存挑战</span>
      </div>
      <div class="recent-body">
        <table class="recent-table">
          <thead>
            <tr>
              <th>存活时长</th>
              <th>得分</th>
              <th>错误题数</th>
              <th>最高难度</th>
              <th>日期时间</th>
            </tr>
          </thead>
          <tbody id="recent-history-body"></tbody>
        </table>
        <div id="recent-history-empty" class="recent-empty">当前还没有练习记录。</div>
      </div>
    </section>

    <footer class="app-footer">
      本页面为单文件 H5，自适应手机与电脑访问。登录后数据同步至服务器，换设备可继续练习。<br>
      <!-- 每次修改代码后请同步更新此处及登录页的版本号 -->
      <strong>版本 v1.1.1</strong>
    </footer>
  </div>

  <script>
    // ====== 后台管理面板（Admin Panel）DOM ======
    // 管理面板插入到body最底部
    document.addEventListener("DOMContentLoaded", function() {
      loadAdminAuth();
      const adminPanel = document.createElement("div");
      adminPanel.id = "admin-panel";
      adminPanel.style = "display:none;position:fixed;left:0;top:0;width:100vw;height:100vh;padding-top:62px;z-index:1000;background:#FFF;overflow:auto;";
      adminPanel.innerHTML = `
        <div style="max-width:520px;margin:auto;background:#f8f8fc;border-radius:10px;padding:16px 18px;">
        <h2>后台管理（难度与练习设置）</h2>
        <form id="admin-form">
        <table style="border-collapse:collapse;width:100%;margin-top:10px;">
          <thead>
            <tr style="border-bottom:1px solid #e2e2e2;">
              <th>难度名称</th>
              <th>题数/批</th>
              <th>通关准确率 %</th>
              <th>批次限时(秒)</th>
            </tr>
          </thead>
          <tbody id="admin-table-body"></tbody>
        </table>
        <div style="margin-top:18px;margin-bottom:5px;">
          <button id="admin-save-btn" type="submit" style="padding:6px 18px;margin-right:12px;">保存设置</button>
          <button id="admin-close-btn" type="button" style="padding:6px 18px;">关闭返回</button>
          <span id="admin-save-tip" style="margin-left:12px;color:#090;"></span>
        </div>
        </form>
        </div>
      `;
      document.body.appendChild(adminPanel);

      document.getElementById("admin-close-btn").addEventListener("click", function() {
        adminPanel.style.display = "none";
      });
      document.getElementById("admin-form").addEventListener("submit", function(e) {
        e.preventDefault();
        saveAdminSettings();
        document.getElementById("admin-save-tip").textContent = "已保存！";
        setTimeout(()=>{document.getElementById("admin-save-tip").textContent="";},1300);
      });

      function renderAdminTable() {
        const tbody = document.getElementById("admin-table-body");
        const settings = loadCustomSettings();
        tbody.innerHTML = "";
        for (let i = 0; i < DIFFICULTY_MODULE.levels.length; i++) {
          const lvl = DIFFICULTY_MODULE.levels[i];
          const s = settings.levels[i] || {};
          tbody.innerHTML += `
            <tr>
              <td style="text-align:left;font-weight:500">${lvl.name}</td>
              <td>
                <input type="number" min="1" max="99" required style="width:56px" name="batchNum${i}" value="${s.questionsPerBatch||DEFAULT_LEVEL_CONFIGS[i].questionsPerBatch}" />
              </td>
              <td>
                <input type="number" min="10" max="100" step="1" required style="width:56px" name="accuracy${i}" value="${Math.round((s.upgradeAccuracy ?? DEFAULT_LEVEL_CONFIGS[i].upgradeAccuracy)*100)}"/>
              </td>
              <td>
                <input type="number" min="30" max="1200" required style="width:66px" name="timelimit${i}" value="${s.upgradeTimeLimit||DEFAULT_LEVEL_CONFIGS[i].upgradeTimeLimit}" />
              </td>
            </tr>
          `;
        }
      }

      function saveAdminSettings() {
        const form = document.getElementById("admin-form");
        const newLevels = [];
        for (let i = 0; i < DIFFICULTY_MODULE.levels.length; i++) {
          const questionsPerBatch = Number(form["batchNum"+i].value);
          const upgradeAccuracy = Number(form["accuracy"+i].value) / 100;
          const upgradeTimeLimit = Number(form["timelimit"+i].value);

          newLevels.push({questionsPerBatch, upgradeAccuracy, upgradeTimeLimit});
        }
        localStorage.setItem(ADMIN_SETTINGS_KEY, JSON.stringify({levels: newLevels}));
      }
    });

    // ===== 管理配置默认值&Key =====
    const ADMIN_SETTINGS_KEY = "adaptive_math_admin_settings_v1";
    const DEFAULT_LEVEL_CONFIGS = [
      { questionsPerBatch: 10, upgradeAccuracy: 0.95, upgradeTimeLimit: 300 }, // L1
      { questionsPerBatch: 10, upgradeAccuracy: 0.95, upgradeTimeLimit: 300 }, // L2
      { questionsPerBatch: 10, upgradeAccuracy: 0.95, upgradeTimeLimit: 300 }, // L3
      { questionsPerBatch: 10, upgradeAccuracy: 0.95, upgradeTimeLimit: 300 }, // L4
      { questionsPerBatch: 10, upgradeAccuracy: 0.95, upgradeTimeLimit: 330 }, // L5 两位数加一位数/整十数
      { questionsPerBatch: 10, upgradeAccuracy: 0.95, upgradeTimeLimit: 330 }, // L6 两位数减一位数/整十数
      { questionsPerBatch: 10, upgradeAccuracy: 0.95, upgradeTimeLimit: 360 }, // L7
      { questionsPerBatch: 10, upgradeAccuracy: 0.95, upgradeTimeLimit: 360 }, // L8
      { questionsPerBatch: 10, upgradeAccuracy: 0.95, upgradeTimeLimit: 420 }, // L9
      { questionsPerBatch: 10, upgradeAccuracy: 0.95, upgradeTimeLimit: 360 }, // L10
      { questionsPerBatch: 10, upgradeAccuracy: 0.95, upgradeTimeLimit: 420 }, // L11
      { questionsPerBatch: 10, upgradeAccuracy: 0.95, upgradeTimeLimit: 360 }, // L12
      { questionsPerBatch: 10, upgradeAccuracy: 0.95, upgradeTimeLimit: 420 }, // L13
      { questionsPerBatch: 10, upgradeAccuracy: 0.95, upgradeTimeLimit: 420 }, // L14
      { questionsPerBatch: 10, upgradeAccuracy: 0.95, upgradeTimeLimit: 480 }, // L15
      { questionsPerBatch: 10, upgradeAccuracy: 0.95, upgradeTimeLimit: 480 }, // L16
    ];

    // ===== 后台访问口令与登录状态（仅前端保护，防止普通学生误进）=====
    const ADMIN_PIN = "2026"; // TODO：改成你自己的后台访问口令
    const ADMIN_AUTH_KEY = "adaptive_math_admin_authed_v1";
    let adminAuthed = false;

    function loadAdminAuth() {
      try {
        adminAuthed = localStorage.getItem(ADMIN_AUTH_KEY) === "1";
      } catch (e) {
        adminAuthed = false;
      }
    }

    function saveAdminAuth() {
      try {
        localStorage.setItem(ADMIN_AUTH_KEY, adminAuthed ? "1" : "0");
      } catch (e) {
        // ignore
      }
    }

    function loadCustomSettings() {
      try {
        const data = localStorage.getItem(ADMIN_SETTINGS_KEY);
        if (!data) return {levels: []};
        const obj = JSON.parse(data);
        if (obj && obj.levels && Array.isArray(obj.levels))
          return obj;
        return {levels: []};
      } catch(e) {
        return {levels: []};
      }
    }

    function getLevelSetting(idx) {
      const set = loadCustomSettings();
      // 填默认
      const def = DEFAULT_LEVEL_CONFIGS[idx] || DEFAULT_LEVEL_CONFIGS[0];
      if (!set.levels[idx]) return def;
      // merge
      return {
        questionsPerBatch: set.levels[idx].questionsPerBatch || def.questionsPerBatch,
        upgradeAccuracy: typeof set.levels[idx].upgradeAccuracy==="number" ? set.levels[idx].upgradeAccuracy : def.upgradeAccuracy,
        upgradeTimeLimit: set.levels[idx].upgradeTimeLimit || def.upgradeTimeLimit
      };
    }

    // ===== 难度模块定义 =====
    const DIFFICULTY_MODULE = {
      levels: [
        {
          id: "L1",
          name: "第 1 级 · 一位数加法入门",
          description: "9 以内一位数加法，无进位为主，适合作为热身。",
          operations: ["+"],
          min: 1,
          max: 9,
          generateQuestion() {
            const a = randomInt(this.min, this.max);
            let bMax = this.max;
            if (Math.random() < 0.7) {
              bMax = Math.min(this.max, 9 - a);
            }
            const b = randomInt(this.min, Math.max(this.min, bMax));
            const answer = a + b;
            const text = `${a} + ${b} = ?`;
            return { a, b, op: "+", text, answer, baseLevelId: this.id };
          }
        },
        {
          id: "L2",
          name: "第 2 级 · 一位数加法进阶",
          description: "一位数加法，包含进位，熟练 10 以内凑整。",
          operations: ["+"],
          min: 2,
          max: 9,
          generateQuestion() {
            const a = randomInt(this.min, this.max);
            let b;
            if (a <= 4) {
              b = randomInt(6, this.max);
            } else {
              const minB = Math.max(this.min, 10 - a);
              b = randomInt(minB, this.max);
            }
            const answer = a + b;
            const text = `${a} + ${b} = ?`;
            return { a, b, op: "+", text, answer, baseLevelId: this.id };
          }
        },
        {
          id: "L3",
          name: "第 3 级 · 一位数加减混合",
          description: "9 以内加减混合，巩固“凑整”和“退整”的概念。",
          operations: ["+", "-"],
          min: 1,
          max: 9,
          generateQuestion() {
            const op = Math.random() < 0.5 ? "+" : "-";
            let a, b, answer;
            if (op === "+") {
              a = randomInt(this.min, this.max);
              const minB = Math.max(this.min, 10 - a);
              b = randomInt(minB, this.max);
              answer = a + b;
            } else {
              a = randomInt(4, this.max);
              b = randomInt(this.min, Math.min(a, 9));
              answer = a - b;
            }
            const text = `${a} ${op} ${b} = ?`;
            return { a, b, op, text, answer, baseLevelId: this.id };
          }
        },
        {
          id: "L4",
          name: "第 4 级 · 两位数加减基础",
          description: "20 以内两位数加减，包含简单进退位，迈向笔算。",
          operations: ["+", "-"],
          min: 6,
          max: 20,
          generateQuestion() {
            const op = Math.random() < 0.5 ? "+" : "-";
            let a, b, answer;
            if (op === "+") {
              a = randomInt(6, 15);
              b = randomInt(4, 9);
              answer = a + b;
            } else {
              a = randomInt(11, 20);
              b = randomInt(2, 9);
              if (a % 10 >= b && Math.random() < 0.4) {
                // no-op
              } else {
                const tenPart = Math.floor(a / 10) * 10;
                const unit = randomInt(0, 4);
                a = tenPart + unit;
                b = randomInt(unit + 1, 9);
              }
              answer = a - b;
            }
            const text = `${a} ${op} ${b} = ?`;
            return { a, b, op, text, answer, baseLevelId: this.id };
          }
        },
        {
          id: "L5",
          name: "第 5 级 · 两位数加一位数/整十数",
          description: "两位数加一位数或整十数，整十数巩固位值，一位数侧重进位。",
          operations: ["+"],
          min: 20,
          max: 99,
          generateQuestion() {
            let a, b, answer;
            a = randomInt(20, 99);
            if (Math.random() < 0.4) {
              b = randomInt(1, 9) * 10;
            } else {
              if (Math.random() < 0.75) {
                const aUnit = a % 10;
                const minB = Math.max(4, 10 - aUnit);
                b = randomInt(minB, 9);
              } else {
                b = randomInt(4, 9);
              }
            }
            answer = a + b;
            const text = `${a} + ${b} = ?`;
            return { a, b, op: "+", text, answer, baseLevelId: this.id };
          }
        },
        {
          id: "L6",
          name: "第 6 级 · 两位数减一位数/整十数",
          description: "两位数减一位数或整十数，整十数巩固位值，一位数侧重退位。",
          operations: ["-"],
          min: 20,
          max: 99,
          generateQuestion() {
            let a, b, answer;
            if (Math.random() < 0.4) {
              a = randomInt(20, 99);
              const maxTen = Math.floor(a / 10);
              b = randomInt(1, maxTen) * 10;
            } else {
              if (Math.random() < 0.75) {
                const ten = randomInt(2, 9);
                const unitA = randomInt(0, 7);
                b = randomInt(unitA + 1, 9);
                a = ten * 10 + unitA;
              } else {
                b = randomInt(2, 9);
                const unitA = randomInt(b, 9);
                const ten = randomInt(2, 9);
                a = ten * 10 + unitA;
              }
            }
            answer = a - b;
            const text = `${a} - ${b} = ?`;
            return { a, b, op: "-", text, answer, baseLevelId: this.id };
          }
        },
        {
          id: "L7",
          name: "第 7 级 · 两位数加两位数（进位）",
          description: "两位数加两位数，进位为主，结果不超过 100，与 L8 衔接。",
          operations: ["+"],
          min: 10,
          max: 99,
          generateQuestion() {
            let a, b, answer;
            a = randomInt(10, 80);
            const maxB = 100 - a;
            if (Math.random() < 0.8) {
              const aUnit = a % 10;
              const minUnitB = Math.max(1, 10 - aUnit);
              const maxUnitB = Math.min(9, maxB - 10);
              if (maxUnitB >= minUnitB) {
                const unitB = randomInt(minUnitB, maxUnitB);
                const maxTenB = Math.floor((maxB - unitB) / 10);
                const tenB = randomInt(1, Math.max(1, maxTenB));
                b = tenB * 10 + unitB;
              } else {
                b = randomInt(10, maxB);
              }
            } else {
              b = randomInt(10, Math.min(99, maxB));
            }
            if (b < 10) b = 10;
            if (a + b > 100) b = 100 - a;
            answer = a + b;
            const text = `${a} + ${b} = ?`;
            return { a, b, op: "+", text, answer, baseLevelId: this.id };
          }
        },
        {
          id: "L8",
          name: "第 8 级 · 两位数减两位数（退位）",
          description: "两位数减两位数，退位为主，巩固“借一当十”。",
          operations: ["-"],
          min: 20,
          max: 99,
          generateQuestion() {
            let a, b, answer;
            if (Math.random() < 0.8) {
              const ten = randomInt(3, 9);
              const unitA = randomInt(0, 8);
              const unitB = randomInt(unitA + 1, 9);
              a = ten * 10 + unitA;
              b = randomInt(1, ten - 1) * 10 + unitB;
            } else {
              a = randomInt(20, 99);
              b = randomInt(10, a - 1);
            }
            if (b > a) [a, b] = [b, a];
            answer = a - b;
            const text = `${a} - ${b} = ?`;
            return { a, b, op: "-", text, answer, baseLevelId: this.id };
          }
        },
        {
          id: "L9",
          name: "第 9 级 · 两位数加减混合",
          description: "两位数加减混合，进位与退位交替出现，结果不超过 100。",
          operations: ["+", "-"],
          min: 10,
          max: 99,
          generateQuestion() {
            const op = Math.random() < 0.5 ? "+" : "-";
            let a, b, answer;
            if (op === "+") {
              a = randomInt(10, 80);
              const maxB = 100 - a;
              const aUnit = a % 10;
              const minUnitB = Math.max(1, 10 - aUnit);
              const maxUnitB = Math.min(9, maxB - 10);
              if (Math.random() < 0.7 && maxUnitB >= minUnitB) {
                const unitB = randomInt(minUnitB, maxUnitB);
                const maxTenB = Math.floor((maxB - unitB) / 10);
                const tenB = randomInt(1, Math.max(1, maxTenB));
                b = tenB * 10 + unitB;
              } else {
                b = randomInt(10, Math.min(99, maxB));
              }
              if (b < 10) b = 10;
              if (a + b > 100) b = 100 - a;
              answer = a + b;
            } else {
              // 倾向出现退位
              if (Math.random() < 0.7) {
                const ten = randomInt(3, 9);
                const unitA = randomInt(0, 8);
                const unitB = randomInt(unitA + 1, 9);
                a = ten * 10 + unitA;
                b = randomInt(1, ten - 1) * 10 + unitB;
              } else {
                a = randomInt(20, 99);
                b = randomInt(10, a - 1);
              }
              if (b > a) [a, b] = [b, a];
              answer = a - b;
            }
            const text = `${a} ${op} ${b} = ?`;
            return { a, b, op, text, answer, baseLevelId: this.id };
          }
        },
        {
          id: "L10",
          name: "第 10 级 · 乘法口诀基础",
          description: "1 到 9 的乘法口诀，打牢乘法基础。",
          operations: ["×"],
          min: 1,
          max: 9,
          generateQuestion() {
            const a = randomInt(this.min, this.max);
            const b = randomInt(this.min, this.max);
            const answer = a * b;
            const text = `${a} × ${b} = ?`;
            return { a, b, op: "×", text, answer, baseLevelId: this.id };
          }
        },
        {
          id: "L11",
          name: "第 11 级 · 两位除一位整除",
          description: "两位数除以一位数，结果为整数，巩固乘除互逆（乘法口诀的逆运算）。",
          operations: ["÷"],
          min: 2,
          max: 9,
          generateQuestion() {
            const divisor = randomInt(this.min, this.max);
            const quotient = randomInt(2, 9);
            const dividend = divisor * quotient;
            const answer = quotient;
            const text = `${dividend} ÷ ${divisor} = ?`;
            return { a: dividend, b: divisor, op: "÷", text, answer, baseLevelId: this.id };
          }
        },
        {
          id: "L12",
          name: "第 12 级 · 两位数加两位数（结果超100）",
          description: "两位数加两位数，结果超过 100，引入三位数，衔接乘法。",
          operations: ["+"],
          min: 10,
          max: 99,
          generateQuestion() {
            let a, b, answer;
            a = randomInt(10, 99);
            const minB = Math.max(10, 101 - a);
            if (Math.random() < 0.8) {
              const aUnit = a % 10;
              const minUnitB = Math.max(1, 10 - aUnit);
              const unitB = randomInt(minUnitB, 9);
              const needTenB = Math.ceil((minB - unitB) / 10);
              const maxTenB = Math.floor((99 - unitB) / 10);
              if (maxTenB >= needTenB) {
                const tenB = randomInt(needTenB, maxTenB);
                b = tenB * 10 + unitB;
              } else {
                b = randomInt(minB, 99);
              }
            } else {
              b = randomInt(minB, 99);
            }
            answer = a + b;
            const text = `${a} + ${b} = ?`;
            return { a, b, op: "+", text, answer, baseLevelId: this.id };
          }
        },
        {
          id: "L13",
          name: "第 13 级 · 两位乘一位",
          description: "两位数乘一位数，结果不超过 100，为多位数乘法竖式打基础。",
          operations: ["×"],
          min: 2,
          max: 9,
          generateQuestion() {
            let a, b, answer;
            b = randomInt(this.min, this.max);
            const maxA = Math.floor(99 / b);
            const minA = 11;
            a = maxA >= minA ? randomInt(minA, maxA) : minA;
            answer = a * b;
            const text = `${a} × ${b} = ?`;
            return { a, b, op: "×", text, answer, baseLevelId: this.id };
          }
        },
        {
          id: "L14",
          name: "第 14 级 · 两位乘一位的逆运算",
          description: "两位数或三位数除以一位数，商为两位数，对应两位乘一位的除法。",
          operations: ["÷"],
          min: 2,
          max: 9,
          generateQuestion() {
            const divisor = randomInt(this.min, this.max);
            const quotient = randomInt(11, 99);
            const dividend = divisor * quotient;
            const answer = quotient;
            const text = `${dividend} ÷ ${divisor} = ?`;
            return { a: dividend, b: divisor, op: "÷", text, answer, baseLevelId: this.id };
          }
        },
        {
          id: "L15",
          name: "第 15 级 · 不带括号的四则运算",
          description: "3 个数 2 个运算符，先乘除后加减，单步难度至 L11。",
          operations: ["+", "-", "×", "÷"],
          min: 1,
          max: 99,
          generateQuestion() {
            const templates = [
              () => { const b = randomInt(1, 9); const c = randomInt(1, 9); const a = randomInt(0, Math.min(99, 100 - b * c)); return { text: `${a} + ${b} × ${c} = ?`, answer: a + b * c }; },
              () => { const a = randomInt(1, 9); const b = randomInt(1, 9); const c = randomInt(0, Math.min(99, 100 - a * b)); return { text: `${a} × ${b} + ${c} = ?`, answer: a * b + c }; },
              () => { const c = randomInt(2, 9); const b = c * randomInt(2, 9); if (b > 81) return null; const a = randomInt(0, Math.min(99, 100 - b / c)); return { text: `${a} + ${b} ÷ ${c} = ?`, answer: a + b / c }; },
              () => { const b = randomInt(2, 9); const a = b * randomInt(2, 9); if (a > 81) return null; const c = randomInt(0, Math.min(99, 100 - a / b)); return { text: `${a} ÷ ${b} + ${c} = ?`, answer: a / b + c }; },
              () => { const b = randomInt(1, 9); const c = randomInt(1, 9); const a = randomInt(b * c, Math.min(99, 100)); return { text: `${a} − ${b} × ${c} = ?`, answer: a - b * c }; },
              () => { const a = randomInt(1, 9); const b = randomInt(1, 9); const c = randomInt(0, a * b); return { text: `${a} × ${b} − ${c} = ?`, answer: a * b - c }; },
              () => { const c = randomInt(2, 9); const b = c * randomInt(2, 9); if (b > 81) return null; const a = randomInt(b / c, 99); return { text: `${a} − ${b} ÷ ${c} = ?`, answer: a - b / c }; },
              () => { const b = randomInt(2, 9); const a = b * randomInt(2, 9); if (a > 81) return null; const c = randomInt(0, a / b); return { text: `${a} ÷ ${b} − ${c} = ?`, answer: a / b - c }; },
              () => { const a = randomInt(0, 50); const b = randomInt(0, Math.min(50, 100 - a)); const c = randomInt(0, Math.min(50, 100 - a - b)); return { text: `${a} + ${b} + ${c} = ?`, answer: a + b + c }; },
              () => { const a = randomInt(20, 99); const b = randomInt(0, Math.min(50, a)); const c = randomInt(0, Math.min(50, a - b)); return { text: `${a} − ${b} − ${c} = ?`, answer: a - b - c }; },
              () => { const a = randomInt(1, 4); const b = randomInt(1, 4); const c = randomInt(1, Math.min(4, Math.floor(81 / (a * b)))); return { text: `${a} × ${b} × ${c} = ?`, answer: a * b * c }; },
              () => { const c = randomInt(2, 9); const b = randomInt(2, 9); const a = b * c * randomInt(1, 4); if (a > 81) return null; return { text: `${a} ÷ ${b} ÷ ${c} = ?`, answer: a / b / c }; },
              () => { const a = randomInt(1, 9); const b = randomInt(1, 9); const c = randomInt(2, 9); if ((a * b) % c !== 0) return null; return { text: `${a} × ${b} ÷ ${c} = ?`, answer: a * b / c }; },
              () => { const b = randomInt(2, 9); const a = b * randomInt(2, 9); if (a > 81) return null; const c = randomInt(1, 9); return { text: `${a} ÷ ${b} × ${c} = ?`, answer: a / b * c }; },
              () => { const a = randomInt(0, 50); const b = randomInt(0, 50); const c = randomInt(0, Math.min(99, a + b)); return { text: `${a} + ${b} − ${c} = ?`, answer: a + b - c }; },
              () => { const a = randomInt(10, 99); const b = randomInt(0, a); const c = randomInt(0, 99); return { text: `${a} − ${b} + ${c} = ?`, answer: a - b + c }; }
            ];
            for (let i = 0; i < 20; i++) {
              const t = templates[randomInt(0, templates.length - 1)];
              const r = t();
              if (r && Number.isInteger(r.answer) && r.answer >= 0) return { a: 0, b: 0, op: "+", text: r.text, answer: r.answer, baseLevelId: this.id };
            }
            const fallback = templates[0]();
            return { a: 0, b: 0, op: "+", text: (fallback && fallback.text) || "1 + 2 + 3 = ?", answer: (fallback && fallback.answer) || 6, baseLevelId: this.id };
          }
        },
        {
          id: "L16",
          name: "第 16 级 · 带括号的四则运算",
          description: "3 个数 2 个运算符，一对括号改变运算顺序，单步难度至 L11。",
          operations: ["+", "-", "×", "÷"],
          min: 1,
          max: 99,
          generateQuestion() {
            const templates = [
              () => { const a = randomInt(1, 8); const b = randomInt(1, 9 - a); const c = randomInt(1, 9); return { text: `(${a} + ${b}) × ${c} = ?`, answer: (a + b) * c }; },
              () => { const a = randomInt(2, 9); const b = randomInt(1, a - 1); const c = randomInt(1, 9); return { text: `(${a} − ${b}) × ${c} = ?`, answer: (a - b) * c }; },
              () => { const c = randomInt(2, 9); const quotient = randomInt(2, 9); const sum = c * quotient; if (sum < 10 || sum > 18) return null; const a = randomInt(1, sum - 1); const b = sum - a; return { text: `(${a} + ${b}) ÷ ${c} = ?`, answer: (a + b) / c }; },
              () => { const a = randomInt(2, 9); const b = randomInt(1, a - 1); const c = randomInt(2, 9); if ((a - b) % c !== 0) return null; return { text: `(${a} − ${b}) ÷ ${c} = ?`, answer: (a - b) / c }; },
              () => { const a = randomInt(1, 9); const b = randomInt(1, 8); const c = randomInt(1, 9 - b); return { text: `${a} × (${b} + ${c}) = ?`, answer: a * (b + c) }; },
              () => { const a = randomInt(1, 9); const b = randomInt(2, 9); const c = randomInt(1, b - 1); return { text: `${a} × (${b} − ${c}) = ?`, answer: a * (b - c) }; },
              () => { const bc = randomInt(2, 9); const a = bc * randomInt(2, 9); if (a > 81) return null; const b = randomInt(1, bc - 1); const c = bc - b; return { text: `${a} ÷ (${b} + ${c}) = ?`, answer: a / (b + c) }; },
              () => { const bc = randomInt(2, 9); const a = bc * randomInt(2, 9); if (a > 81) return null; const b = randomInt(bc + 1, 9); const c = b - bc; return { text: `${a} ÷ (${b} − ${c}) = ?`, answer: a / (b - c) }; },
              () => { const a = randomInt(0, 90); const b = randomInt(1, 9); const c = randomInt(1, 9); return { text: `${a} + (${b} × ${c}) = ?`, answer: a + b * c }; },
              () => { const b = randomInt(1, 9); const c = randomInt(1, 9); const a = randomInt(b * c, 99); return { text: `${a} − (${b} × ${c}) = ?`, answer: a - b * c }; },
              () => { const c = randomInt(2, 9); const b = c * randomInt(2, 9); if (b > 81) return null; const a = randomInt(0, 100 - b / c); return { text: `${a} + (${b} ÷ ${c}) = ?`, answer: a + b / c }; },
              () => { const c = randomInt(2, 9); const b = c * randomInt(2, 9); if (b > 81) return null; const a = randomInt(b / c, 99); return { text: `${a} − (${b} ÷ ${c}) = ?`, answer: a - b / c }; }
            ];
            for (let i = 0; i < 20; i++) {
              const t = templates[randomInt(0, templates.length - 1)];
              const r = t();
              if (r && Number.isInteger(r.answer) && r.answer >= 0) return { a: 0, b: 0, op: "+", text: r.text, answer: r.answer, baseLevelId: this.id };
            }
            return { a: 1, b: 1, op: "+", text: "(1 + 1) × 1 = ?", answer: 2, baseLevelId: this.id };
          }
        }
      ]
    };

    // ========= 生存挑战模式：全局状态 =========
    const SURVIVAL_INITIAL_SEC = 60;
    const SURVIVAL_CORRECT_PER_LEVEL = 5;

    let currentLevelIndex = 0;
    let currentQuestion = null;
    let survivalTimeLeft = 0;
    let survivalTimerId = null;
    let runScore = 0;
    let consecutiveCorrect = 0;
    let gameStartTime = 0;
    let gameOver = false;
    let isPlaying = false;
    let maxLevelThisRun = 0;
    let runWrongCount = 0;

    // ========= DOM引用 =========
    const dom = {};

    function initDomRefs() {
      dom.currentLevelName = document.getElementById("current-level-name");
      dom.survivalTime = document.getElementById("survival-time");
      dom.consecutiveCorrect = document.getElementById("consecutive-correct");
      dom.runScore = document.getElementById("run-score");
      dom.bestSurvivalTime = document.getElementById("best-survival-time");
      dom.bestScore = document.getElementById("best-score");

      dom.timerChip = document.getElementById("timer-chip");
      dom.timerValue = document.getElementById("timer-value");
      dom.questionText = document.getElementById("question-text");
      dom.questionSubtext = document.getElementById("question-subtext");
      dom.answerForm = document.getElementById("answer-form");
      dom.answerInput = document.getElementById("answer-input");
      dom.submitBtn = document.getElementById("submit-btn");
      dom.startGameBtn = document.getElementById("start-game-btn");
      dom.feedback = document.getElementById("feedback");
      dom.batchSummary = document.getElementById("batch-summary");
      dom.gameOverPanel = document.getElementById("game-over-panel");
      dom.playAgainBtn = document.getElementById("play-again-btn");
      dom.currentUsernameLabel = document.getElementById("current-username-label");
      dom.recentHistoryBody = document.getElementById("recent-history-body");
      dom.recentHistoryEmpty = document.getElementById("recent-history-empty");
    }

    // ===== 工具函数 =====
    function randomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function clamp(value, min, max) {
      return Math.max(min, Math.min(max, value));
    }

    function formatSeconds(sec) {
      sec = Math.max(0, Math.round(sec));
      if (sec < 60) return sec + "s";
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return s === 0 ? m + "min" : m + "min " + s + "s";
    }

    function formatDateTime(ts) {
      const d = new Date(ts);
      if (Number.isNaN(d.getTime())) return "-";
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      return `${y}-${m}-${day} ${hh}:${mm}`;
    }

    // ===== 学员账户与 localStorage 状态读写 =====
    const USER_ACCOUNTS_KEY = "adaptive_math_users_v1";
    const CURRENT_USER_KEY = "adaptive_math_current_user_v1";
    const GUEST_STORAGE_KEY = "adaptive_math_survival_guest_v1";
    const GUEST_PLAY_LIMIT = 3;

    let currentUsername = null;
    let isGuestMode = false;
    let cachedUser = null;

    function getApiBase() {
      return (typeof window !== "undefined" && window.API_BASE_URL) || "";
    }

    async function apiLogin(username, password) {
      const base = getApiBase();
      if (!base) return null;
      const res = await fetch(base + "/api/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      });
      const data = await res.json();
      return data;
    }

    async function apiGetUser(username) {
      const base = getApiBase();
      if (!base) return null;
      const res = await fetch(base + "/api/user/" + encodeURIComponent(username));
      const data = await res.json();
      return data.ok ? data.user : null;
    }

    async function apiPutUser(username, updates) {
      const base = getApiBase();
      if (!base) return null;
      const res = await fetch(base + "/api/user/" + encodeURIComponent(username), {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updates)
      });
      const data = await res.json();
      return data.ok ? data.user : null;
    }

    async function apiAppendSurvivalRun(username, runEntry) {
      const base = getApiBase();
      if (!base) return;
      try {
        await fetch(base + "/api/user/" + encodeURIComponent(username) + "/runs", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(runEntry)
        });
        const u = cachedUser || {};
        if (!Array.isArray(u.recentSurvivalRuns)) u.recentSurvivalRuns = [];
        u.recentSurvivalRuns.unshift(runEntry);
        if (u.recentSurvivalRuns.length > 10) u.recentSurvivalRuns = u.recentSurvivalRuns.slice(0, 10);
        if ((runEntry.survivalTimeSec || 0) > (u.bestSurvivalSec || 0)) u.bestSurvivalSec = runEntry.survivalTimeSec;
        if ((runEntry.score || 0) > (u.bestScore || 0)) u.bestScore = runEntry.score;
        u.totalScore = (u.totalScore || 0) + (runEntry.score || 0);
        cachedUser = u;
        const updated = await apiPutUser(username, {
          bestSurvivalSec: u.bestSurvivalSec,
          bestScore: u.bestScore,
          totalScore: u.totalScore,
          recentSurvivalRuns: u.recentSurvivalRuns
        });
        if (updated) cachedUser = updated;
      } catch (e) {
        console.warn("同步记录到服务器失败", e);
      }
      renderRecentSurvivalRuns();
    }

    function loadUsers() {
      try {
        const raw = localStorage.getItem(USER_ACCOUNTS_KEY);
        if (!raw) return [];
        const data = JSON.parse(raw);
        if (data && Array.isArray(data.users)) return data.users;
        return [];
      } catch (e) {
        return [];
      }
    }

    function saveUsers(users) {
      try {
        localStorage.setItem(USER_ACCOUNTS_KEY, JSON.stringify({ users }));
      } catch (e) {
        console.warn("写入学员账户失败。", e);
      }
    }

    function setCurrentUsername(name) {
      currentUsername = name;
      try {
        if (name) {
          localStorage.setItem(CURRENT_USER_KEY, name);
        } else {
          localStorage.removeItem(CURRENT_USER_KEY);
        }
      } catch (e) {
        // ignore
      }
    }

    function loadCurrentUsername() {
      if (currentUsername) return currentUsername;
      try {
        const name = localStorage.getItem(CURRENT_USER_KEY);
        currentUsername = name || null;
      } catch (e) {
        currentUsername = null;
      }
      return currentUsername;
    }

    function getCurrentUser() {
      if (isGuestMode) return null;
      if (cachedUser) return cachedUser;
      const name = loadCurrentUsername();
      if (!name) return null;
      const users = loadUsers();
      return users.find(u => u.username === name) || null;
    }

    function getGuestSurvivalData() {
      try {
        const raw = localStorage.getItem(GUEST_STORAGE_KEY);
        if (!raw) return { bestSurvivalSec: 0, bestScore: 0, recentSurvivalRuns: [], guestPlayCount: 0 };
        const data = JSON.parse(raw);
        return {
          bestSurvivalSec: typeof data.bestSurvivalSec === "number" ? data.bestSurvivalSec : 0,
          bestScore: typeof data.bestScore === "number" ? data.bestScore : 0,
          recentSurvivalRuns: Array.isArray(data.recentSurvivalRuns) ? data.recentSurvivalRuns : [],
          guestPlayCount: typeof data.guestPlayCount === "number" ? data.guestPlayCount : 0
        };
      } catch (e) {
        return { bestSurvivalSec: 0, bestScore: 0, recentSurvivalRuns: [], guestPlayCount: 0 };
      }
    }

    function saveGuestSurvivalRun(survivalTimeSec, score, maxLevel, wrongCount) {
      const data = getGuestSurvivalData();
      data.guestPlayCount = (data.guestPlayCount || 0) + 1;
      data.recentSurvivalRuns.unshift({
        survivalTimeSec,
        score,
        maxLevel,
        wrongCount: wrongCount ?? 0,
        ts: Date.now()
      });
      if (data.recentSurvivalRuns.length > 10) {
        data.recentSurvivalRuns = data.recentSurvivalRuns.slice(0, 10);
      }
      if (survivalTimeSec > data.bestSurvivalSec) data.bestSurvivalSec = survivalTimeSec;
      if (score > data.bestScore) data.bestScore = score;
      try {
        localStorage.setItem(GUEST_STORAGE_KEY, JSON.stringify(data));
      } catch (e) {
        console.warn("写入游客记录失败。", e);
      }
    }

    function ensureUserProgressDefault(user) {
      if (!user) return;
      if (typeof user.levelIndex !== "number") user.levelIndex = 0;
      if (typeof user.bestLevelIndex !== "number") user.bestLevelIndex = user.levelIndex;
      if (typeof user.totalScore !== "number") user.totalScore = 0;
      if (!Array.isArray(user.history)) user.history = [];
      if (typeof user.bestSurvivalSec !== "number") user.bestSurvivalSec = 0;
      if (typeof user.bestScore !== "number") user.bestScore = 0;
      if (!Array.isArray(user.recentSurvivalRuns)) user.recentSurvivalRuns = [];
    }

    function loadState() {
      const user = getCurrentUser();
      if (!user) return;
      ensureUserProgressDefault(user);
    }

    function formatSurvivalTime(sec) {
      sec = Math.max(0, Math.round(sec));
      if (sec < 60) return sec + " 秒";
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return s === 0 ? m + " 分" : m + " 分 " + s + " 秒";
    }

    function appendSurvivalRun(survivalTimeSec, score, maxLevel, wrongCount) {
      wrongCount = wrongCount ?? 0;
      if (isGuestMode) {
        saveGuestSurvivalRun(survivalTimeSec, score, maxLevel, wrongCount);
        return;
      }
      const name = loadCurrentUsername();
      if (!name) return;
      const runEntry = { survivalTimeSec, score, maxLevel, wrongCount, ts: Date.now() };
      if (getApiBase()) {
        apiAppendSurvivalRun(name, runEntry);
        return;
      }
      const users = loadUsers();
      const idx = users.findIndex(u => u.username === name);
      if (idx === -1) return;
      ensureUserProgressDefault(users[idx]);
      const u = users[idx];
      if (!Array.isArray(u.recentSurvivalRuns)) u.recentSurvivalRuns = [];
      u.recentSurvivalRuns.unshift(runEntry);
      if (u.recentSurvivalRuns.length > 10) {
        u.recentSurvivalRuns = u.recentSurvivalRuns.slice(0, 10);
      }
      if (survivalTimeSec > (u.bestSurvivalSec || 0)) {
        u.bestSurvivalSec = survivalTimeSec;
      }
      if (score > (u.bestScore || 0)) {
        u.bestScore = score;
      }
      u.totalScore = (u.totalScore || 0) + score;
      saveUsers(users);
    }

    function renderRecentSurvivalRuns() {
      if (!dom.recentHistoryBody || !dom.recentHistoryEmpty) return;
      const runs = isGuestMode
        ? getGuestSurvivalData().recentSurvivalRuns
        : (() => {
            const user = getCurrentUser();
            if (!user) return [];
            ensureUserProgressDefault(user);
            return Array.isArray(user.recentSurvivalRuns) ? user.recentSurvivalRuns : [];
          })();
      if (runs.length === 0) {
        dom.recentHistoryBody.innerHTML = "";
        dom.recentHistoryEmpty.style.display = "block";
        return;
      }
      dom.recentHistoryEmpty.style.display = "none";
      const rows = runs.slice(0, 10).map(r => {
        const timeStr = formatSurvivalTime(r.survivalTimeSec || 0);
        const wrongStr = (r.wrongCount != null ? r.wrongCount : "-").toString();
        const levelName = DIFFICULTY_MODULE.levels[r.maxLevel] ? DIFFICULTY_MODULE.levels[r.maxLevel].id : "-";
        const dateStr = formatDateTime(r.ts);
        return `<tr>
          <td>${timeStr}</td>
          <td>${r.score || 0}</td>
          <td>${wrongStr}</td>
          <td>${levelName}</td>
          <td>${dateStr}</td>
        </tr>`;
      });
      dom.recentHistoryBody.innerHTML = rows.join("");
    }

    // ===== 题目生成与队列逻辑 =====
    function generateBaseQuestion() {
      const level = DIFFICULTY_MODULE.levels[currentLevelIndex];
      return level.generateQuestion();
    }

    // ===== 生存模式：计时与 UI 更新 =====
    function updateSurvivalStatusUI() {
      const m = Math.floor(survivalTimeLeft / 60);
      const s = survivalTimeLeft % 60;
      const timeStr = m + ":" + String(s).padStart(2, "0");
      if (dom.survivalTime) dom.survivalTime.textContent = timeStr;
      if (dom.timerValue) dom.timerValue.textContent = timeStr;
      if (dom.timerChip) {
        dom.timerChip.classList.toggle("low", survivalTimeLeft <= 10);
      }
      const level = DIFFICULTY_MODULE.levels[currentLevelIndex];
      if (dom.currentLevelName) dom.currentLevelName.textContent = level ? level.name : "-";
      if (dom.consecutiveCorrect) dom.consecutiveCorrect.textContent = consecutiveCorrect + " / " + SURVIVAL_CORRECT_PER_LEVEL;
      if (dom.runScore) dom.runScore.textContent = runScore;
      if (isGuestMode) {
        const guest = getGuestSurvivalData();
        if (dom.bestSurvivalTime) {
          dom.bestSurvivalTime.textContent = guest.bestSurvivalSec ? formatSurvivalTime(guest.bestSurvivalSec) : "-";
        }
        if (dom.bestScore) dom.bestScore.textContent = (guest.bestScore != null && guest.bestScore > 0) ? guest.bestScore : "-";
        if (dom.currentUsernameLabel) dom.currentUsernameLabel.textContent = "游客";
      } else {
        const user = getCurrentUser();
        if (user) {
          ensureUserProgressDefault(user);
          if (dom.bestSurvivalTime) {
            dom.bestSurvivalTime.textContent = user.bestSurvivalSec ? formatSurvivalTime(user.bestSurvivalSec) : "-";
          }
          if (dom.bestScore) dom.bestScore.textContent = (user.bestScore != null && user.bestScore > 0) ? user.bestScore : "-";
        }
        if (dom.currentUsernameLabel) dom.currentUsernameLabel.textContent = loadCurrentUsername() || "-";
      }
    }

    function setFeedback(message, type) {
      dom.feedback.textContent = "";
      dom.feedback.classList.remove("correct", "incorrect");
      if (!message) return;
      dom.feedback.innerHTML = message;
      if (type === "correct") dom.feedback.classList.add("correct");
      if (type === "incorrect") dom.feedback.classList.add("incorrect");
    }

    function setBatchSummary(text) {
      if (dom.batchSummary) dom.batchSummary.innerHTML = text || "";
    }

    function renderQuestion(question) {
      if (!question) return;
      dom.questionText.textContent = question.text;
      dom.questionSubtext.textContent = "";
      dom.answerInput.value = "";
      setFeedback("", null);
      // 保持输入框焦点，避免手机软键盘收起、画面反复缩放
      dom.answerInput.focus();
      setTimeout(function () {
        dom.answerInput.focus();
      }, 50);
    }

    function startSurvivalGame() {
      if (isGuestMode) {
        const guest = getGuestSurvivalData();
        if ((guest.guestPlayCount || 0) >= GUEST_PLAY_LIMIT) {
          setBatchSummary("试用只限三次，继续使用请联系管理员添加账号。");
          return;
        }
      }
      if (survivalTimerId) clearInterval(survivalTimerId);
      currentLevelIndex = 0;
      survivalTimeLeft = SURVIVAL_INITIAL_SEC;
      runScore = 0;
      consecutiveCorrect = 0;
      runWrongCount = 0;
      gameStartTime = Date.now();
      gameOver = false;
      isPlaying = true;
      maxLevelThisRun = 0;
      if (dom.gameOverPanel) dom.gameOverPanel.style.display = "none";
      if (dom.startGameBtn) dom.startGameBtn.style.display = "none";
      if (dom.submitBtn) {
        dom.submitBtn.style.display = "";
        dom.submitBtn.disabled = false;
      }
      dom.answerInput.disabled = false;
      setBatchSummary("");
      updateSurvivalStatusUI();
      survivalTimerId = setInterval(survivalTick, 1000);
      showNextSurvivalQuestion();
    }

    function survivalTick() {
      if (!isPlaying || gameOver) return;
      survivalTimeLeft -= 1;
      updateSurvivalStatusUI();
      if (survivalTimeLeft <= 0) {
        clearInterval(survivalTimerId);
        survivalTimerId = null;
        endSurvivalGame();
      }
    }

    function showNextSurvivalQuestion() {
      if (!isPlaying || gameOver) return;
      currentQuestion = generateBaseQuestion();
      renderQuestion(currentQuestion);
    }

    function endSurvivalGame(completed) {
      if (survivalTimerId) {
        clearInterval(survivalTimerId);
        survivalTimerId = null;
      }
      isPlaying = false;
      gameOver = true;
      if (dom.submitBtn) dom.submitBtn.disabled = true;
      dom.answerInput.disabled = true;
      const survivalTimeSec = Math.round((Date.now() - gameStartTime) / 1000);
      appendSurvivalRun(survivalTimeSec, runScore, maxLevelThisRun, runWrongCount);
      renderRecentSurvivalRuns();
      if (dom.gameOverPanel) {
        dom.gameOverPanel.style.display = "block";
        const titleEl = document.getElementById("game-over-title");
        if (titleEl) titleEl.textContent = completed ? "恭喜通关" : "Game Over";
        const durationEl = document.getElementById("game-over-duration");
        const scoreEl = document.getElementById("game-over-score");
        const maxLevelEl = document.getElementById("game-over-max-level");
        const bestTimeEl = document.getElementById("game-over-best-time");
        const bestScoreEl = document.getElementById("game-over-best-score");
        if (durationEl) durationEl.textContent = formatSurvivalTime(survivalTimeSec);
        if (scoreEl) scoreEl.textContent = runScore;
        const wrongEl = document.getElementById("game-over-wrong");
        if (wrongEl) wrongEl.textContent = runWrongCount;
        const level = DIFFICULTY_MODULE.levels[maxLevelThisRun];
        if (maxLevelEl) maxLevelEl.textContent = level ? level.name : "-";
        if (isGuestMode) {
          const guest = getGuestSurvivalData();
          if (bestTimeEl) bestTimeEl.textContent = guest.bestSurvivalSec ? formatSurvivalTime(guest.bestSurvivalSec) : "-";
          if (bestScoreEl) bestScoreEl.textContent = (guest.bestScore != null && guest.bestScore > 0) ? guest.bestScore : "-";
        } else {
          const user = getCurrentUser();
          if (user) {
            if (bestTimeEl) bestTimeEl.textContent = user.bestSurvivalSec ? formatSurvivalTime(user.bestSurvivalSec) : "-";
            if (bestScoreEl) bestScoreEl.textContent = (user.bestScore != null && user.bestScore > 0) ? user.bestScore : "-";
          }
        }
      }
      if (dom.startGameBtn) dom.startGameBtn.style.display = "none";
      if (dom.playAgainBtn) dom.playAgainBtn.style.display = "";
    }

    function handleSubmit() {
      if (!isPlaying || gameOver || !currentQuestion) return;
      // 提交后尽快把焦点拉回输入框，避免手机软键盘收起
      if (dom.answerInput) dom.answerInput.focus();
      const value = dom.answerInput.value.trim();
      if (value === "") {
        setFeedback("<span class='feedback-title'>提示：</span>请先输入答案。", null);
        dom.answerInput.focus();
        return;
      }
      const userAnswer = Number(value);
      if (!Number.isFinite(userAnswer)) {
        setFeedback("<span class='feedback-title'>提示：</span>请输入有效数字。", null);
        return;
      }
      evaluateAnswerSurvival(userAnswer);
    }

    function evaluateAnswerSurvival(userAnswer) {
      const question = currentQuestion;
      if (!question) return;
      const isCorrect = userAnswer === question.answer;

      if (isCorrect) {
        survivalTimeLeft += 2;
        const points = currentLevelIndex + 1;
        runScore += points;
        consecutiveCorrect += 1;
        if (consecutiveCorrect >= SURVIVAL_CORRECT_PER_LEVEL) {
          if (currentLevelIndex < DIFFICULTY_MODULE.levels.length - 1) {
            currentLevelIndex += 1;
            consecutiveCorrect = 0;
          } else {
            maxLevelThisRun = Math.max(maxLevelThisRun, currentLevelIndex);
            setFeedback(
              "<span class='feedback-title'>答对！</span> 恭喜通关全部 16 级！",
              "correct"
            );
            updateSurvivalStatusUI();
            setTimeout(function () { endSurvivalGame(true); }, 600);
            return;
          }
        }
        maxLevelThisRun = Math.max(maxLevelThisRun, currentLevelIndex);
        setFeedback(
          "<span class='feedback-title'>答对！</span> +1 秒，+" + points + " 分",
          "correct"
        );
      } else {
        runWrongCount += 1;
        consecutiveCorrect = 0;
        if (currentLevelIndex > 0) currentLevelIndex -= 1;
        setFeedback(
          "<span class='feedback-title'>答错了。</span> 正确答案：<strong>" + question.answer + "</strong>",
          "incorrect"
        );
      }
      updateSurvivalStatusUI();
      setTimeout(showNextSurvivalQuestion, 600);
    }

    // ===== 登录 / 注销 =====
    async function handleLogin() {
      const usernameInput = document.getElementById("login-username");
      const passwordInput = document.getElementById("login-password");
      const errorEl = document.getElementById("login-error");
      const username = (usernameInput.value || "").trim();
      const password = passwordInput.value || "";

      if (!username || !password) {
        errorEl.textContent = "请输入用户名和密码。";
        return;
      }

      if (getApiBase()) {
        const data = await apiLogin(username, password);
        if (!data || !data.ok) {
          errorEl.textContent = data && data.error ? data.error : "登录失败，请检查网络或联系老师。";
          return;
        }
        cachedUser = data.user;
      } else {
        const users = loadUsers();
        const user = users.find(u => u.username === username);
        if (!user) {
          errorEl.textContent = "用户不存在，请联系老师在后台添加。";
          return;
        }
        if (user.password !== password) {
          errorEl.textContent = "密码错误。";
          return;
        }
        cachedUser = user;
      }

      setCurrentUsername(username);
      ensureUserProgressDefault(cachedUser);
      errorEl.textContent = "";
      document.getElementById("login-view").style.display = "none";
      document.getElementById("app-view").style.display = "flex";
      loadState();
      updateSurvivalStatusUI();
      renderRecentSurvivalRuns();
      if (dom.submitBtn) dom.submitBtn.style.display = "none";
      if (dom.startGameBtn) dom.startGameBtn.style.display = "";
      if (dom.gameOverPanel) dom.gameOverPanel.style.display = "none";
      if (dom.playAgainBtn) dom.playAgainBtn.style.display = "none";
    }

    function handleGuestEnter() {
      const guest = getGuestSurvivalData();
      if ((guest.guestPlayCount || 0) >= GUEST_PLAY_LIMIT) {
        const errorEl = document.getElementById("login-error");
        if (errorEl) errorEl.textContent = "试用只限三次，继续使用请联系管理员添加账号。";
        return;
      }
      isGuestMode = true;
      setCurrentUsername(null);
      document.getElementById("login-view").style.display = "none";
      document.getElementById("app-view").style.display = "flex";
      const errorEl = document.getElementById("login-error");
      if (errorEl) errorEl.textContent = "";
      loadState();
      updateSurvivalStatusUI();
      renderRecentSurvivalRuns();
      if (dom.submitBtn) dom.submitBtn.style.display = "none";
      if (dom.startGameBtn) dom.startGameBtn.style.display = "";
      if (dom.gameOverPanel) dom.gameOverPanel.style.display = "none";
      if (dom.playAgainBtn) dom.playAgainBtn.style.display = "none";
    }

    function handleLogout() {
      isGuestMode = false;
      cachedUser = null;
      setCurrentUsername(null);
      document.getElementById("app-view").style.display = "none";
      document.getElementById("login-view").style.display = "flex";
      const errorEl = document.getElementById("login-error");
      if (errorEl) errorEl.textContent = "";
      const pwd = document.getElementById("login-password");
      if (pwd) pwd.value = "";
    }

    // ===== 事件绑定与初始化 =====
    function bindEvents() {
      if (dom.answerForm) {
        dom.answerForm.addEventListener("submit", function (e) {
          e.preventDefault();
          handleSubmit();
        });
      }
      // 提交后立即把焦点拉回输入框，减少手机软键盘收起、画面缩放
      dom.submitBtn.addEventListener("mousedown", function () {
        if (dom.answerInput && isPlaying && !gameOver) dom.answerInput.focus();
      });
      dom.submitBtn.addEventListener("touchstart", function () {
        if (dom.answerInput && isPlaying && !gameOver) dom.answerInput.focus();
      }, { passive: true });
      if (dom.startGameBtn) dom.startGameBtn.addEventListener("click", startSurvivalGame);
      if (dom.playAgainBtn) dom.playAgainBtn.addEventListener("click", () => {
        if (dom.playAgainBtn) dom.playAgainBtn.style.display = "none";
        startSurvivalGame();
      });

      dom.answerInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          handleSubmit();
        }
      });
      // 键盘「前往/Go」等也会触发表单 submit，无需再绑 click

      const loginBtn = document.getElementById("login-btn");
      loginBtn.addEventListener("click", handleLogin);
      const guestBtn = document.getElementById("guest-btn");
      if (guestBtn) guestBtn.addEventListener("click", handleGuestEnter);
      const loginPassword = document.getElementById("login-password");
      loginPassword.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          handleLogin();
        }
      });

      const logoutBtn = document.getElementById("logout-btn");
      logoutBtn.addEventListener("click", handleLogout);
    }

    async function init() {
      initDomRefs();
      bindEvents();
      const name = loadCurrentUsername();
      if (!name) {
        document.getElementById("login-view").style.display = "flex";
        document.getElementById("app-view").style.display = "none";
        return;
      }
      if (getApiBase()) {
        try {
          const user = await apiGetUser(name);
          if (user) {
            cachedUser = user;
            ensureUserProgressDefault(cachedUser);
            document.getElementById("login-view").style.display = "none";
            document.getElementById("app-view").style.display = "flex";
            loadState();
            updateSurvivalStatusUI();
            renderRecentSurvivalRuns();
            if (dom.submitBtn) dom.submitBtn.style.display = "none";
            if (dom.startGameBtn) dom.startGameBtn.style.display = "";
            if (dom.gameOverPanel) dom.gameOverPanel.style.display = "none";
            if (dom.playAgainBtn) dom.playAgainBtn.style.display = "none";
            return;
          }
        } catch (e) {
          console.warn("从服务器加载用户失败，尝试本地", e);
        }
      }
      const user = loadUsers().find(u => u.username === name);
      if (user) {
        cachedUser = user;
        ensureUserProgressDefault(cachedUser);
        document.getElementById("login-view").style.display = "none";
        document.getElementById("app-view").style.display = "flex";
        loadState();
        updateSurvivalStatusUI();
        renderRecentSurvivalRuns();
        if (dom.submitBtn) dom.submitBtn.style.display = "none";
        if (dom.startGameBtn) dom.startGameBtn.style.display = "";
        if (dom.gameOverPanel) dom.gameOverPanel.style.display = "none";
        if (dom.playAgainBtn) dom.playAgainBtn.style.display = "none";
      } else {
        document.getElementById("login-view").style.display = "flex";
        document.getElementById("app-view").style.display = "none";
      }
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>

