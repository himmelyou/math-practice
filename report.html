<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>学员练习记录 · Jarvis Math Lab 计算游戏</title>
  <script src="config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Segoe UI", Roboto, sans-serif;
      background: #eef4ff;
      color: #123047;
      padding: 16px;
    }
    .wrapper {
      max-width: 800px;
      margin: 0 auto;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.06);
      padding: 20px 24px;
    }
    h1 { margin: 0 0 8px; font-size: 1.35rem; color: #0d47a1; }
    .subtitle { margin: 0 0 16px; font-size: 0.88rem; color: #607d8b; }
    .select-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .select-row label { font-weight: 600; font-size: 0.9rem; }
    .select-row select {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #c5d3ea;
      font-size: 0.95rem;
      min-width: 140px;
    }
    .auth-tip { color: #d32f2f; font-size: 0.88rem; margin-bottom: 12px; }
    .stats-row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 20px;
      padding: 12px 16px;
      background: #f5f9ff;
      border-radius: 10px;
    }
    .stat-item { font-size: 0.9rem; }
    .stat-item strong { color: #1976d2; }
    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 0.88rem;
    }
    th, td {
      border-bottom: 1px solid #e8ecf4;
      padding: 10px 8px;
      text-align: center;
    }
    th {
      background: #f0f4ff;
      font-weight: 600;
      font-size: 0.82rem;
    }
    td:first-child { text-align: left; }
    .empty-msg { text-align: center; padding: 40px 20px; color: #607d8b; }
    .back-link {
      display: inline-block;
      margin-bottom: 12px;
      color: #1976d2;
      text-decoration: none;
      font-size: 0.9rem;
    }
    .back-link:hover { text-decoration: underline; }
    .tab-row {
      display: flex;
      gap: 0;
      margin-bottom: 16px;
      border-bottom: 1px solid #e0e0e0;
    }
    .tab-btn {
      padding: 10px 20px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 0.95rem;
      color: #607d8b;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
    }
    .tab-btn.active {
      color: #1976d2;
      font-weight: 600;
      border-bottom-color: #1976d2;
    }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }
    .wrong-item {
      padding: 12px 0;
      border-bottom: 1px solid #eee;
      font-size: 0.92rem;
    }
    .wrong-item:last-child { border-bottom: none; }
    .wrong-item .q { font-weight: 600; margin-bottom: 4px; }
    .wrong-item .wrong-ans { color: #d32f2f; }
    .wrong-item .correct-ans { color: #2e7d32; }
    .level-chart-wrap { margin-top: 16px; margin-bottom: 20px; }
    .level-chart-row { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 12px; }
    .level-chart-row label { font-weight: 600; font-size: 0.9rem; }
    .level-chart-row select { padding: 6px 10px; border-radius: 6px; border: 1px solid #c5d3ea; min-width: 120px; }
    .level-summary-table { font-size: 0.85rem; margin-bottom: 20px; }
  </style>
</head>
<body>
  <div class="wrapper">
    <a href="admin.html" class="back-link">← 返回后台管理</a>
    <h1>学员练习记录</h1>
    <p class="subtitle">选择学员查看其全部练习记录（生存挑战 + 闯关挑战），按时间排序，用于观察练习效果与计算水平变化。</p>

    <div id="auth-tip" class="auth-tip"></div>

    <div class="select-row" id="select-row" style="display:none;">
      <label for="user-select">选择学员：</label>
      <select id="user-select">
        <option value="">-- 请选择 --</option>
      </select>
    </div>

    <div class="stats-row" id="stats-row" style="display:none;">
      <span class="stat-item">个人最佳存活：<strong id="stat-best-time">-</strong></span>
      <span class="stat-item">个人最高得分：<strong id="stat-best-score">-</strong></span>
      <span class="stat-item">总局数：<strong id="stat-total">0</strong></span>
    </div>

    <div class="tab-row" id="tab-row" style="display:none;">
      <button type="button" class="tab-btn active" id="tab-records">挑战记录</button>
      <button type="button" class="tab-btn" id="tab-wrong">错题分析</button>
      <button type="button" class="tab-btn" id="tab-level">数据分析</button>
    </div>

    <div class="tab-panel active" id="panel-records">
    <table id="records-table" style="display:none;">
      <thead>
        <tr>
          <th>序号</th>
          <th>挑战类型</th>
          <th>存活时长</th>
          <th>得分</th>
          <th>错误题数</th>
          <th>最高难度</th>
          <th>日期时间</th>
        </tr>
      </thead>
      <tbody id="records-body"></tbody>
    </table>
    <div id="empty-msg" class="empty-msg" style="display:none;">该学员暂无练习记录。</div>
    </div>

    <div class="tab-panel" id="panel-wrong">
      <div id="wrong-list" class="wrong-list"></div>
      <div id="wrong-empty" class="empty-msg" style="display:none;">该学员暂无错题记录。</div>
    </div>

    <div class="tab-panel" id="panel-level">
      <p class="subtitle" style="margin-top:0;">各难度正确率与平均每题用时（基于最近 500 局内的答题记录），可按日查看进步变化。</p>
      <div class="level-chart-wrap" id="level-chart-wrap" style="display:none;">
        <div class="level-chart-row">
          <label for="level-chart-select">选择难度：</label>
          <select id="level-chart-select"></select>
        </div>
        <div style="position:relative;height:280px;">
          <canvas id="level-chart-canvas"></canvas>
        </div>
      </div>
      <div id="level-summary-wrap">
        <table class="level-summary-table" id="level-summary-table" style="display:none;">
          <thead>
            <tr><th>难度</th><th>答题数</th><th>正确率</th><th>平均每题用时(秒)</th></tr>
          </thead>
          <tbody id="level-summary-body"></tbody>
        </table>
        <div id="level-summary-empty" class="empty-msg" style="display:none;">暂无按题记录的难度数据，请学员多玩几局后查看。</div>
      </div>
    </div>
    <p style="margin-top:20px;margin-bottom:0;font-size:0.78rem;color:#607d8b;text-align:center;">版本 v1.5.0</p>
  </div>

  <script>
    const LEVEL_NAMES = [
      "第 1 级 · 一位数加法入门",
      "第 2 级 · 一位数加法进阶",
      "第 3 级 · 一位数加减混合",
      "第 4 级 · 两位数加减基础",
      "第 5 级 · 两位数加一位数/整十数",
      "第 6 级 · 两位数减一位数/整十数",
      "第 7 级 · 两位数加两位数（进位）",
      "第 8 级 · 两位数减两位数（退位）",
      "第 9 级 · 两位数加减混合",
      "第 10 级 · 乘法口诀基础",
      "第 11 级 · 两位除一位整除",
      "第 12 级 · 两位数加两位数（结果超100）",
      "第 13 级 · 两位乘一位",
      "第 14 级 · 两位乘一位的逆运算",
      "第 15 级 · 不带括号的四则运算",
      "第 16 级 · 带括号的四则运算"
    ];

    function getApiBase() {
      return (typeof window !== "undefined" && window.API_BASE_URL) || "";
    }

    function formatSurvivalTime(sec) {
      sec = Math.max(0, Math.round(sec));
      if (sec < 60) return sec + " 秒";
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return s === 0 ? m + " 分" : m + " 分 " + s + " 秒";
    }

    function formatDateTime(ts) {
      const d = new Date(ts);
      if (Number.isNaN(d.getTime())) return "-";
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      return `${y}-${m}-${day} ${hh}:${mm}`;
    }

    const ADMIN_PIN = "2026";
    const ADMIN_AUTH_KEY = "adaptive_math_admin_authed_v1";

    function checkAuth() {
      const saved = localStorage.getItem(ADMIN_AUTH_KEY);
      if (saved === "1") return true;
      const input = window.prompt("请输入后台访问口令：");
      if (input === ADMIN_PIN) {
        localStorage.setItem(ADMIN_AUTH_KEY, "1");
        return true;
      }
      return false;
    }

    async function loadUserList() {
      const base = getApiBase();
      if (!base) return [];
      const res = await fetch(base + "/api/admin/user-list", {
        headers: { "X-Admin-Pin": ADMIN_PIN }
      });
      const data = await res.json();
      return data.ok ? data.users : [];
    }

    async function loadUserRecords(username) {
      const base = getApiBase();
      if (!base) return [];
      const res = await fetch(base + "/api/admin/records/" + encodeURIComponent(username), {
        headers: { "X-Admin-Pin": ADMIN_PIN }
      });
      const data = await res.json();
      return data.ok ? data.runs : [];
    }

    async function loadUserInfo(username) {
      const base = getApiBase();
      if (!base) return null;
      const res = await fetch(base + "/api/user/" + encodeURIComponent(username));
      const data = await res.json();
      return data.ok ? data.user : null;
    }

    function escapeHtml(s) {
      const div = document.createElement("div");
      div.textContent = s;
      return div.innerHTML;
    }

    function renderRecords(runs, user) {
      const tbody = document.getElementById("records-body");
      const table = document.getElementById("records-table");
      const emptyMsg = document.getElementById("empty-msg");
      const statsRow = document.getElementById("stats-row");

      if (!runs || runs.length === 0) {
        table.style.display = "none";
        emptyMsg.style.display = "block";
        emptyMsg.textContent = "该学员暂无练习记录。";
      } else {
        table.style.display = "table";
        emptyMsg.style.display = "none";
        tbody.innerHTML = runs.map((r, i) => {
          const typeStr = r.mode === "level" ? "闯关挑战" : (r.mode === "training" ? "训练模式" : "生存挑战");
          const timeStr = formatSurvivalTime(r.survivalTimeSec || 0);
          const wrongStr = (r.wrongCount != null ? r.wrongCount : "-").toString();
          const levelName = LEVEL_NAMES[r.maxLevel] || "-";
          const dateStr = formatDateTime(r.ts);
          return `<tr>
            <td>${i + 1}</td>
            <td>${typeStr}</td>
            <td>${timeStr}</td>
            <td>${r.score || 0}</td>
            <td>${wrongStr}</td>
            <td>${levelName}</td>
            <td>${dateStr}</td>
          </tr>`;
        }).join("");
      }

      if (user) {
        statsRow.style.display = "flex";
        document.getElementById("stat-best-time").textContent = user.bestSurvivalSec
          ? formatSurvivalTime(user.bestSurvivalSec) : "-";
        document.getElementById("stat-best-score").textContent = (user.bestScore != null && user.bestScore > 0)
          ? user.bestScore : "-";
        document.getElementById("stat-total").textContent = runs ? runs.length : 0;
      }
    }

    function renderWrongAnswers(wrongs) {
      const list = document.getElementById("wrong-list");
      const empty = document.getElementById("wrong-empty");
      if (!wrongs || wrongs.length === 0) {
        list.innerHTML = "";
        empty.style.display = "block";
        empty.textContent = "该学员暂无错题记录。";
        return;
      }
      empty.style.display = "none";
      list.innerHTML = wrongs.map(w => `
        <div class="wrong-item">
          <div class="q">${escapeHtml(w.text || "")}</div>
          <div>学员答案：<span class="wrong-ans">${escapeHtml(String(w.studentAnswer ?? ""))}</span> · 正确答案：<span class="correct-ans">${escapeHtml(String(w.answer ?? ""))}</span></div>
        </div>
      `).join("");
    }

    function aggregateByLevel(runs) {
      const byLevel = Array.from({ length: 16 }, () => ({ total: 0, correct: 0, totalTimeMs: 0 }));
      if (!runs || !runs.length) return byLevel;
      runs.forEach(r => {
        if (!Array.isArray(r.attempts)) return;
        r.attempts.forEach(a => {
          const idx = Math.max(0, Math.min(15, Number(a.levelIndex) || 0));
          byLevel[idx].total += 1;
          if (a.correct) byLevel[idx].correct += 1;
          byLevel[idx].totalTimeMs += Number(a.timeSpentMs) || 0;
        });
      });
      return byLevel;
    }

    function aggregateByDayAndLevel(runs) {
      const byDay = {};
      if (!runs || !runs.length) return byDay;
      runs.forEach(r => {
        const ts = r.ts || 0;
        const d = new Date(ts);
        const dateStr = d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, "0") + "-" + String(d.getDate()).padStart(2, "0");
        if (!byDay[dateStr]) byDay[dateStr] = Array.from({ length: 16 }, () => ({ total: 0, correct: 0, totalTimeMs: 0 }));
        if (!Array.isArray(r.attempts)) return;
        r.attempts.forEach(a => {
          const idx = Math.max(0, Math.min(15, Number(a.levelIndex) || 0));
          byDay[dateStr][idx].total += 1;
          if (a.correct) byDay[dateStr][idx].correct += 1;
          byDay[dateStr][idx].totalTimeMs += Number(a.timeSpentMs) || 0;
        });
      });
      return byDay;
    }

    let levelChartInstance = null;
    function renderLevelChart(byDay, levelIndex) {
      const dates = Object.keys(byDay).sort();
      const wrap = document.getElementById("level-chart-wrap");
      const sel = document.getElementById("level-chart-select");
      if (dates.length === 0 || !sel.value) {
        if (levelChartInstance) { levelChartInstance.destroy(); levelChartInstance = null; }
        wrap.style.display = "none";
        return;
      }
      wrap.style.display = "block";
      const acc = dates.map(d => {
        const L = byDay[d][levelIndex];
        const total = L.total || 0;
        const correct = L.correct || 0;
        const totalTimeMs = L.totalTimeMs || 0;
        return {
          date: d,
          accuracy: total > 0 ? Math.round((correct / total) * 100) : null,
          avgSec: total > 0 ? Math.round((totalTimeMs / total) / 1000 * 10) / 10 : null
        };
      });
      const canvas = document.getElementById("level-chart-canvas");
      if (levelChartInstance) levelChartInstance.destroy();
      levelChartInstance = new Chart(canvas, {
        type: "line",
        data: {
          labels: acc.map(x => x.date),
          datasets: [
            { label: "正确率(%)", data: acc.map(x => x.accuracy), borderColor: "#1976d2", backgroundColor: "rgba(25,118,210,0.1)", yAxisID: "y", tension: 0.2 },
            { label: "平均每题用时(秒)", data: acc.map(x => x.avgSec), borderColor: "#2e7d32", backgroundColor: "rgba(46,125,50,0.1)", yAxisID: "y1", tension: 0.2 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { type: "linear", position: "left", min: 0, max: 100, title: { display: true, text: "正确率(%)" } },
            y1: { type: "linear", position: "right", min: 0, title: { display: true, text: "平均用时(秒)" }, grid: { drawOnChartArea: false } }
          }
        }
      });
    }

    function renderLevelAnalysis(runs) {
      const byLevel = aggregateByLevel(runs);
      const byDay = aggregateByDayAndLevel(runs);
      const table = document.getElementById("level-summary-table");
      const tbody = document.getElementById("level-summary-body");
      const empty = document.getElementById("level-summary-empty");
      const hasAny = byLevel.some(l => l.total > 0);
      if (!hasAny) {
        table.style.display = "none";
        empty.style.display = "block";
        document.getElementById("level-chart-wrap").style.display = "none";
        if (levelChartInstance) { levelChartInstance.destroy(); levelChartInstance = null; }
        return;
      }
      empty.style.display = "none";
      table.style.display = "table";
      tbody.innerHTML = byLevel.map((l, i) => {
        const acc = l.total > 0 ? Math.round((l.correct / l.total) * 100) : "-";
        const avgSec = l.total > 0 ? (Math.round((l.totalTimeMs / l.total) / 1000 * 10) / 10) : "-";
        return `<tr><td>${LEVEL_NAMES[i] || "L" + (i + 1)}</td><td>${l.total}</td><td>${acc}${l.total > 0 ? "%" : ""}</td><td>${avgSec}</td></tr>`;
      }).join("");
      const levelSelect = document.getElementById("level-chart-select");
      levelSelect.innerHTML = Array.from({ length: 16 }, (_, i) => `<option value="${i}">${LEVEL_NAMES[i] || "L" + (i + 1)}</option>`).join("");
      const firstWithData = byLevel.findIndex(l => l.total > 0);
      levelSelect.value = firstWithData >= 0 ? firstWithData : 0;
      renderLevelChart(byDay, parseInt(levelSelect.value, 10));
      levelSelect.onchange = () => renderLevelChart(byDay, parseInt(levelSelect.value, 10));
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const authTip = document.getElementById("auth-tip");
      const selectRow = document.getElementById("select-row");
      const userSelect = document.getElementById("user-select");

      if (!checkAuth()) {
        authTip.textContent = "口令错误或取消输入，已禁止访问。";
        return;
      }

      const base = getApiBase();
      if (!base) {
        authTip.textContent = "未配置 API 服务器地址（config.js 中的 API_BASE_URL），无法加载数据。";
        return;
      }

      authTip.textContent = "";
      selectRow.style.display = "flex";

      const users = await loadUserList();
      users.sort((a, b) => (a || "").localeCompare(b || "", "zh-CN"));
      userSelect.innerHTML = '<option value="">-- 请选择 --</option>' +
        users.map(u => `<option value="${u}">${u}</option>`).join("");

      const tabRecords = document.getElementById("tab-records");
      const tabWrong = document.getElementById("tab-wrong");
      const tabLevel = document.getElementById("tab-level");
      const panelRecords = document.getElementById("panel-records");
      const panelWrong = document.getElementById("panel-wrong");
      const panelLevel = document.getElementById("panel-level");

      tabRecords.addEventListener("click", () => {
        tabRecords.classList.add("active");
        tabWrong.classList.remove("active");
        tabLevel.classList.remove("active");
        panelRecords.classList.add("active");
        panelWrong.classList.remove("active");
        panelLevel.classList.remove("active");
      });
      tabWrong.addEventListener("click", () => {
        tabWrong.classList.add("active");
        tabRecords.classList.remove("active");
        tabLevel.classList.remove("active");
        panelWrong.classList.add("active");
        panelRecords.classList.remove("active");
        panelLevel.classList.remove("active");
      });
      tabLevel.addEventListener("click", () => {
        tabLevel.classList.add("active");
        tabRecords.classList.remove("active");
        tabWrong.classList.remove("active");
        panelLevel.classList.add("active");
        panelRecords.classList.remove("active");
        panelWrong.classList.remove("active");
      });

      userSelect.addEventListener("change", async () => {
        const username = userSelect.value;
        if (!username) {
          document.getElementById("stats-row").style.display = "none";
          document.getElementById("tab-row").style.display = "none";
          document.getElementById("panel-records").classList.add("active");
          document.getElementById("panel-wrong").classList.remove("active");
          document.getElementById("tab-records").classList.add("active");
          document.getElementById("tab-wrong").classList.remove("active");
          document.getElementById("records-table").style.display = "none";
          document.getElementById("empty-msg").style.display = "block";
          document.getElementById("empty-msg").textContent = "请选择学员。";
          document.getElementById("wrong-list").innerHTML = "";
          document.getElementById("wrong-empty").style.display = "block";
          document.getElementById("wrong-empty").textContent = "请选择学员。";
          document.getElementById("level-summary-table").style.display = "none";
          document.getElementById("level-summary-empty").style.display = "block";
          document.getElementById("level-summary-empty").textContent = "请选择学员。";
          document.getElementById("level-chart-wrap").style.display = "none";
          if (levelChartInstance) { levelChartInstance.destroy(); levelChartInstance = null; }
          return;
        }
        document.getElementById("tab-row").style.display = "flex";
        const [runs, user] = await Promise.all([
          loadUserRecords(username),
          loadUserInfo(username)
        ]);
        renderRecords(runs, user);
        const wrongs = (user && Array.isArray(user.wrongAnswers)) ? user.wrongAnswers : [];
        renderWrongAnswers(wrongs);
        renderLevelAnalysis(runs);
      });
    });
  </script>
</body>
</html>
